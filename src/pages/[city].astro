---
import fs from 'node:fs';
import path from 'node:path';
import { parse } from 'csv-parse/sync';
import MainLayout from '../layouts/MainLayout.astro';
import { SITE_CONFIG } from '../config.js';
import { Image } from 'astro:assets';

const allImages = import.meta.glob('../assets/gallery/fl/*.{jpeg,jpg,png,gif,webp}');
const imagePaths = Object.keys(allImages);

export async function getStaticPaths() {
  const filePath = path.resolve('./src/data/cities.csv');
  const fileContent = fs.readFileSync(filePath, 'utf-8');
  const records = parse(fileContent, { columns: true, skip_empty_lines: true, bom: true });
  const validCities = records.map(r => r.City.toLowerCase());
  return records.map((row: any) => ({
    params: { city: `tree-removal-${row.City.toLowerCase().replace(/\s+/g, '-')}` },
    props: { cityData: row, validCities: validCities },
  }));
}

const { cityData, validCities } = Astro.props;

const imageIndex = Math.abs(cityData.City.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0)) % imagePaths.length;
const selectedImageImport = allImages[imagePaths[imageIndex]];
// @ts-ignore
const selectedImage = (await selectedImageImport()).default;

const nearby = cityData.NearbyCities 
  ? cityData.NearbyCities.split(',').map(c => c.trim()).filter(c => validCities.includes(c.toLowerCase())) : [];

const treeType = cityData.MainTreeType || 'native Florida trees';
const populationFormatted = Number(cityData.Population).toLocaleString();

const reviewPool = [
  { name: "John D.", text: `Amazing service in ${cityData.City}! Highly professional.` },
  { name: "Sarah W.", text: `Best prices in ${cityData.County} County. Left my yard cleaner than they found it.` },
  { name: "Michael B.", text: `Fast emergency response in ${cityData.City} within hours.` },
  { name: "Emily R.", text: `Expert palm trimming. My property looks 100% better.` }
];
const review1 = reviewPool[cityData.City.length % reviewPool.length];
const review2 = reviewPool[(cityData.City.length + 2) % reviewPool.length];
---

<MainLayout title={`${cityData.City} Tree Removal & Trimming`} description={cityData.Description}>
  <header style="background: linear-gradient(135deg, #1b4332 0%, #081c15 100%); color: white; padding: 5rem 1rem; text-align: center; border-bottom: 5px solid #f97316;">
    <div class="container">
      <h1 style="margin: 0; font-size: clamp(2.2rem, 8vw, 3.8rem); font-weight: 900; line-height: 1.1;">{cityData.City} Tree Services</h1>
      <p style="font-size: 1.4rem; margin-top: 1.5rem; color: #95d5b2;">Serving the {populationFormatted} residents of {cityData.City}.</p>
    </div>
  </header>

  <main class="container" style="max-width: 1000px; margin: -3rem auto 0; padding: 0 1.5rem; position: relative; z-index: 10;">
    <div style="background: white; padding: 3rem 1.5rem; border-radius: 24px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); border: 1px solid #e5e7eb;">
      <a href={SITE_CONFIG.phoneHref} style="background: #ea580c; color: white !important; padding: 1.4rem; text-decoration: none; border-radius: 16px; font-weight: 900; font-size: 2rem; display: block;">{SITE_CONFIG.phone}</a>
    </div>

    <section style="margin-top: 4rem;">
      <Image src={selectedImage} alt={`Tree service in ${cityData.City}`} width={1000} height={540} style="width: 100%; height: auto; border-radius: 24px;" />
    </section>

    <section style="margin-top: 5rem; margin-bottom: 10rem;">
      <h2 style="color: #064e3b; font-size: 2rem; font-weight: 800;">Tree Care in {cityData.City}</h2>
      <p style="font-size: 1.2rem; line-height: 1.8; color: #4b5563;">{cityData.Description}</p>
    </section>
  </main>
</MainLayout>