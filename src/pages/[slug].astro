---
import fs from "node:fs";
import path from "node:path";
import { parse } from "csv-parse/sync";
import MainLayout from "../layouts/MainLayout.astro";
import { SITE_CONFIG } from "../config.js";
import { Image } from "astro:assets";
import premiumFaqs from "../data/premium-faqs.json";
// ‚òÖ YENƒ∞: Tavsiye havuzunu i√ßeri alƒ±yoruz
import arboristTips from "../data/arborist-tips.json";

export async function getStaticPaths() {
  const filePath = path.resolve("./src/data/cities.csv");
  const fileContent = fs.readFileSync(filePath, "utf-8");
  const records = parse(fileContent, {
    columns: true,
    skip_empty_lines: true,
    bom: true,
  });

  const services = [
    { prefix: "tree-removal", name: "Tree Removal", icon: "üå≥" },
    { prefix: "stump-grinding", name: "Stump Grinding", icon: "üèóÔ∏è" },
    { prefix: "emergency-service", name: "Emergency Tree Service", icon: "üå™Ô∏è" },
  ];

  const paths = [];
  records.forEach((row) => {
    if (!row.City) return;
    // D√úZELTME: URL'lerde nokta hatasƒ±nƒ± √∂nlemek i√ßin noktalarƒ± siliyoruz
    const citySlug = row.City.toLowerCase()
      .trim()
      .replace(/\./g, "")
      .replace(/\s+/g, "-");

    services.forEach((service) => {
      paths.push({
        params: { slug: `${service.prefix}-${citySlug}` },
        props: {
          cityData: row,
          serviceInfo: service,
          allServices: services,
          nearby: records
            .filter((r) => r.County === row.County && r.City !== row.City)
            .slice(0, 5),
        },
      });
    });
  });
  return paths;
}

const { cityData, serviceInfo, nearby, allServices } = Astro.props;

const toTitleCase = (str) => {
  if (!str) return "";
  return str
    .toLowerCase()
    .split(" ")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
};

const cityName = toTitleCase(cityData.City);
const landmark = toTitleCase(cityData.Landmark) || "the local area";
const countyName = toTitleCase(cityData.County);
const currentUrl = new URL(Astro.url.pathname, SITE_CONFIG.siteUrl).toString();

// ‚òÖ Dƒ∞NAMƒ∞K ARBORIST TAVSƒ∞YESƒ∞ MANTIƒûI
const tipIndex =
  (cityData.City.length + cityData.Landmark.length) % arboristTips.length;
const selectedTemplate = arboristTips[tipIndex];
const finalDynamicTip = selectedTemplate
  .replaceAll("[City]", cityName)
  .replaceAll("[Landmark]", landmark)
  .replaceAll("[MainTreeType]", cityData.MainTreeType || "local trees")
  .replaceAll(
    "[FocusService]",
    cityData.FocusService || "professional tree care",
  );

// ‚òÖ SEO ≈ûABLON KARI≈ûTIRICI (ZENGƒ∞N METƒ∞N)
const cityTemplates = [
  `In ${cityName}, our tree operations are defined by high-angle rigging precision and an uncompromising focus on safety. For projects located near ${landmark}, our certified teams evaluate the specific structural needs of ${cityData.MainTreeType}, ensuring that every ${serviceInfo.name} or hazard mitigation task aligns with the latest ISA standards. By accounting for the unique wind-load dynamics of ${countyName} County, we provide local property owners with a service that protects both their structures and the long-term vitality of the surrounding landscape.`,
  `The Florida climate in ${cityName} presents unique challenges for native vegetation, especially species like ${cityData.MainTreeType}. Our crews, active throughout ${countyName} County and specifically near ${landmark}, utilize advanced technical pruning to mitigate storm risks before they escalate. We don't just perform ${serviceInfo.name}; we build a comprehensive property plan that accounts for local soil saturation and coastal gust patterns, ensuring your ${cityName} residence remains hazard-free throughout the year.`,
  `Residents near ${landmark} understand the value of a well-maintained canopy. In ${cityName}, our dispatch network specializes in managing complex ${cityData.MainTreeType} projects where property lines and structures are in close proximity. From precision ${serviceInfo.name} to urgent hazard removal, we bring deep ${countyName} County environmental knowledge to every job site. Our goal is simple: providing ${cityName} with elite arborist expertise that enhances curb appeal while prioritizing the safety of your home.`,
  `Professionalism in ${countyName} County tree care requires a balance of biological science and modern engineering. In ${cityName}, we connect you with vetted specialists who understand the complex growth habits of ${cityData.MainTreeType} near ${landmark}. Whether you require a routine ${serviceInfo.name} or a technical canopy reduction, our operations strictly follow safety regulations designed for the unique Florida terrain. We ensure that every landscape in ${cityName} we service is better prepared for environmental stress.`,
];
const templateIndex =
  Math.abs(cityName.split("").reduce((a, b) => a + b.charCodeAt(0), 0)) %
  cityTemplates.length;
const selectedRichText = cityTemplates[templateIndex];

const serviceFolder = serviceInfo.prefix.includes("removal")
  ? "removal"
  : serviceInfo.prefix.includes("stump")
    ? "stump"
    : "emergency";
const allImages = import.meta.glob(
  "../assets/gallery/fl/**/*.{jpeg,jpg,png,gif,webp}",
);
const imagePaths = Object.keys(allImages).filter((p) =>
  p.includes(`/${serviceFolder}/`),
);

let selectedImage = null;
if (imagePaths.length > 0) {
  const imageIndex =
    Math.abs(
      (cityName + serviceInfo.prefix)
        .split("")
        .reduce((a, b) => a + b.charCodeAt(0), 0),
    ) % imagePaths.length;
  const imgModule: any = await allImages[imagePaths[imageIndex]]();
  selectedImage = imgModule.default;
}

const cityKey = cityData.City.toLowerCase()
  .trim()
  .replace(/\./g, "")
  .replace(/\s+/g, "-");
let finalFaqs = premiumFaqs[cityKey] || [];
---

<MainLayout
  title={`#1 ${serviceInfo.name} in ${cityName}, FL | Licensed & Insured`}
  description={cityData.Description}
>
  <header
    style="background: linear-gradient(135deg, #1b4332 0%, #081c15 100%); color: white; padding: 4.5rem 1.5rem; text-align: center; border-bottom: 5px solid #ea580c;"
  >
    <div class="container">
      <div
        style="font-size: 0.85rem; margin-bottom: 1rem; color: #ffb703; font-weight: 800; text-transform: uppercase;"
      >
        Official Service Dispatch ‚Ä¢ {countyName} County
      </div>
      <h1
        style="margin: 0; font-size: clamp(2rem, 7vw, 3.5rem); font-weight: 900; line-height: 1.1;"
      >
        {cityName}
        {serviceInfo.name}
      </h1>
      <p
        style="font-size: 1.25rem; margin-top: 1.2rem; color: #95d5b2; max-width: 750px; margin-left: auto; margin-right: auto;"
      >
        Providing elite care for properties near <strong>{landmark}</strong>.
      </p>
    </div>
  </header>

  <main
    class="container"
    style="max-width: 1100px; margin: -2.5rem auto 0; padding: 0 1rem; position: relative; z-index: 10;"
  >
    <!-- CTA BOX -->
    <div
      style="background: white; padding: 2.5rem 1.5rem; border-radius: 24px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.1); border: 1px solid #eee;"
    >
      <h3
        style="margin: 0 0 10px; color: #064e3b; font-size: 1.6rem; font-weight: 800;"
      >
        Instant Professional Estimate
      </h3>
      <p style="color: #6b7280; margin-bottom: 1.5rem; font-size: 1rem;">
        Connect with verified {serviceInfo.name} specialists in {cityName}.
      </p>
      <a
        href={SITE_CONFIG.phoneHref}
        style="background: #ea580c; color: white !important; padding: 1.2rem; text-decoration: none; border-radius: 12px; font-weight: 900; font-size: clamp(1.4rem, 5vw, 2rem); display: block; box-shadow: 0 10px 25px rgba(234, 88, 12, 0.3); transition: 0.3s;"
        >{SITE_CONFIG.phone}</a
      >
    </div>

    <!-- 3 SIMPLE STEPS -->
    <section style="margin-top: 4rem;">
      <h2
        style="color: #064e3b; font-size: 1.8rem; font-weight: 900; text-align: center; margin-bottom: 2rem;"
      >
        3 Simple Steps to Service
      </h2>
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;"
      >
        <div class="info-card-base step-card">
          <div class="icon-box" style="background: #e0f2fe;">üìû</div>
          <h4>1. Call Dispatch</h4>
          <p>
            Connect with our {cityName} office instantly to discuss your project.
          </p>
        </div>
        <div class="info-card-base step-card">
          <div class="icon-box" style="background: #fef3c7;">üìã</div>
          <h4>2. Get a Quote</h4>
          <p>
            A local specialist will provide an expert assessment and transparent
            pricing.
          </p>
        </div>
        <div class="info-card-base step-card">
          <div class="icon-box" style="background: #dcfce7;">‚úÖ</div>
          <h4>3. Job Completed</h4>
          <p>
            Safe execution and thorough cleanup of your {cityName} property.
          </p>
        </div>
      </div>
    </section>

    <!-- MONITOR & HUB SEKSƒ∞YONU -->
    <section
      style="margin-top: 3.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;"
    >
      <div class="info-card-base">
        <div
          style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;"
        >
          <div>
            <span
              style="background: #1b4332; color: #ffb703; font-size: 0.65rem; padding: 4px 12px; border-radius: 50px; font-weight: 800; text-transform: uppercase;"
              >Local Authority Monitor</span
            ><h4
              style="margin: 8px 0 0; color: #1e293b; font-size: 1.15rem; font-weight: 800;"
            >
              {cityName} Service Status
            </h4>
          </div>
          <div style="text-align: right;">
            <div id="live-dot" class="active-pulse"></div><span
              style="font-size: 0.75rem; font-weight: 900; color: #16a34a;"
              >Active</span>
          </div>
        </div>
        <div
          style="background: #f8fafc; padding: 15px; border-radius: 18px; border: 1px solid #f1f5f9; margin: 10px 0;"
        >
          <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"
          >
            <span
              id="current-date"
              style="font-size: 0.95rem; font-weight: 800; color: #1b4332;"
              >--/--/2026</span
            ><span style="font-size: 1.3rem;">üìÖ</span>
          </div>
          <p
            style="margin: 0; font-size: 0.9rem; color: #4b5563; line-height: 1.5; font-weight: 700; font-style: italic;"
          >
            {finalDynamicTip}
          </p>
        </div>
      </div>
      <div
        style="background: #f0fdf4; padding: 1.8rem; border-radius: 24px; border: 1px solid #dcfce7; display: flex; flex-direction: column; justify-content: center;"
      >
        <h4
          style="margin: 0 0 15px; color: #166534; font-size: 1.15rem; font-weight: 800;"
        >
          Local Service Hub
        </h4>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          {
            allServices
              .filter((s) => s.name !== serviceInfo.name)
              .map((s) => (
                <a
                  href={`/${s.prefix}-${cityData.City.toLowerCase().replace(/\s+/g, "-")}`}
                  class="hub-link-item"
                >
                  <span>{s.icon}</span> {s.name} in {cityName} ‚Üí
                </a>
              ))
          }
        </div>
      </div>
    </section>

    <!-- Bƒ∞LGƒ∞ K√úNYESƒ∞ (YAZI RENKLERƒ∞ BEYAZ YAPILDI ‚úÖ) -->
    <section
      style="margin-top: 2rem; background: #064e3b; color: white; padding: 2rem; border-radius: 24px; display: flex; flex-wrap: wrap; justify-content: space-around; gap: 20px; align-items: center; border: 1px solid #1b4332;"
    >
      <div style="text-align: center;">
        <p
          style="margin: 0; color: #95d5b2; font-size: 0.75rem; font-weight: 800; text-transform: uppercase;"
        >
          Service Area
        </p>
        <p
          style="margin: 5px 0 0; font-weight: 900; font-size: 1.1rem; color: white;"
        >
          {countyName} County
        </p>
      </div>
      <div
        style="text-align: center; border-left: 1px solid rgba(255,255,255,0.1); border-right: 1px solid rgba(255,255,255,0.1); padding: 0 2rem;"
      >
        <p
          style="margin: 0; color: #95d5b2; font-size: 0.75rem; font-weight: 800; text-transform: uppercase;"
        >
          Local Landmark
        </p>
        <p
          style="margin: 5px 0 0; font-weight: 900; font-size: 1.1rem; color: white;"
        >
          {landmark}
        </p>
      </div>
      <div style="text-align: center;">
        <p
          style="margin: 0; color: #95d5b2; font-size: 0.75rem; font-weight: 800; text-transform: uppercase;"
        >
          Dispatch Status
        </p>
        <p
          style="margin: 5px 0 0; font-weight: 900; font-size: 1.1rem; color: #4ade80;"
        >
          ‚óè Active in {cityName}
        </p>
      </div>
    </section>

    <!-- ZENGƒ∞N METƒ∞N ALANI VE G√ñRSEL (ETƒ∞KET GERƒ∞ GELDƒ∞ ‚úÖ) -->
    <section style="margin-top: 5rem;">
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; align-items: center;"
      >
        <div>
          <h2
            style="color: #064e3b; font-size: 1.8rem; font-weight: 900; margin-bottom: 1.5rem;"
          >
            Expert {serviceInfo.name} in {cityName}
          </h2>
          <p style="font-size: 1.1rem; color: #374151; line-height: 1.8;">
            {cityData.Description}
          </p>
          <p
            style="font-size: 1.1rem; color: #4b5563; line-height: 1.8; margin-top: 1rem;"
          >
            {selectedRichText}
          </p>
        </div>
        {
          selectedImage && (
            <div style="position: relative;">
              <Image
                src={selectedImage}
                alt={`${serviceInfo.name} in ${cityName}`}
                width={600}
                height={450}
                format="webp"
                style="width: 100%; height: auto; border-radius: 24px; box-shadow: 0 15px 30px rgba(0,0,0,0.1);"
              />
              <div style="position: absolute; bottom: 15px; right: 15px; background: rgba(0,0,0,0.6); color: white; padding: 5px 12px; border-radius: 50px; font-size: 0.75rem; backdrop-filter: blur(5px);">
                Representative Project
              </div>
            </div>
          )
        }
      </div>
    </section>

    <!-- WHY CHOOSE US -->
    <section style="margin-top: 6rem;">
      <h2
        style="color: #064e3b; font-size: 2rem; font-weight: 900; text-align: center; margin-bottom: 2.5rem;"
      >
        Why Choose Our {cityName} Network?
      </h2>
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px;"
      >
        <div class="info-card-base feature-card">
          <div class="icon-box" style="background: #dcfce7;">üõ°Ô∏è</div>
          <h4>Verified Compliance</h4>
          <p>
            Every specialist is licensed and insured according to Florida's
            strict standards for {cityName}.
          </p>
        </div>
        <div class="info-card-base feature-card">
          <div class="icon-box" style="background: #fef3c7;">üöú</div>
          <h4>Elite Equipment</h4>
          <p>
            High-performance rigging and machinery to handle anything from Pines
            to massive Live Oaks.
          </p>
        </div>
        <div class="info-card-base feature-card">
          <div class="icon-box" style="background: #fee2e2;">üöë</div>
          <h4>Storm Response</h4>
          <p>
            Direct coordination for emergency storm damage and fallen tree
            removal across {countyName} County.
          </p>
        </div>
      </div>
    </section>

    <!-- FAQ B√ñL√úM√ú -->
    <section style="margin-top: 6rem;">
      <h2
        style="color: #064e3b; font-size: 2.2rem; font-weight: 900; text-align: center; margin-bottom: 3rem;"
      >
        Common Questions in {cityName}
      </h2>
      <div style="display: flex; flex-direction: column; gap: 20px;">
        {
          finalFaqs.map((f) => (
            <div style="background: white; padding: 2.5rem; border-radius: 28px; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
              <h4 style="color: #1b4332; font-weight: 800; margin: 0 0 10px; font-size: 1.3rem;">
                {f.q}
              </h4>
              <p style="color: #4b5563; line-height: 1.8; margin: 0; font-size: 1.1rem;">
                {f.a}
              </p>
            </div>
          ))
        }
      </div>
    </section>

    <!-- √áEVRE ≈ûEHƒ∞RLER -->
    <section
      style="margin-top: 6rem; margin-bottom: 12rem; border-top: 1px solid #eee; padding-top: 4rem;"
    >
      <h3
        style="color: #064e3b; font-size: 1.3rem; font-weight: 800; margin-bottom: 2rem; text-align: center;"
      >
        Other Local Dispatch Areas in {countyName} County:
      </h3>
      <div
        style="display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;"
      >
        {
          nearby.map((n: any) => (
            <a
              href={`/tree-removal-${n.City.toLowerCase().trim().replace(/\./g, "").replace(/\s+/g, "-")}`}
              class="nearby-link"
            >
              {toTitleCase(n.City)} Tree Service
            </a>
          ))
        }
      </div>
    </section>
  </main>

  <script is:inline>
    function runAuthorityMonitor() {
      const now = new Date();
      const dateEl = document.getElementById("current-date");
      if (dateEl)
        dateEl.innerText = now.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
    }
    window.addEventListener("DOMContentLoaded", runAuthorityMonitor);
  </script>
</MainLayout>

<style>
  .info-card-base {
    background: white;
    padding: 2.5rem;
    border-radius: 24px;
    border: 1px solid #eee;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.03);
  }
  .step-card {
    text-align: center;
  }
  .feature-card {
    text-align: left;
    transition: transform 0.3s ease;
  }
  .feature-card:hover {
    transform: translateY(-5px);
    border-color: #dcfce7;
  }
  .icon-box {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.6rem;
    margin-bottom: 1.5rem;
  }
  .step-card .icon-box {
    margin-left: auto;
    margin-right: auto;
  }
  h4 {
    font-weight: 900;
    margin: 0 0 12px;
    color: #1b4332;
  }
  p {
    font-size: 0.95rem;
    color: #4b5563;
    line-height: 1.6;
    margin: 0;
  }
  .hub-link-item {
    color: #1b4332;
    text-decoration: none;
    font-size: 0.95rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: 0.2s;
    margin-bottom: 5px;
  }
  .hub-link-item:hover {
    color: #ea580c;
    transform: translateX(5px);
  }
  .nearby-link {
    background: white;
    color: #166534;
    padding: 10px 20px;
    border-radius: 50px;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 700;
    border: 1px solid #e2e8f0;
    transition: 0.2s;
  }
  .nearby-link:hover {
    background: #f0fdf4 !important;
    border-color: #166534 !important;
    transform: translateY(-2px);
  }
  @keyframes live-pulse {
    0% {
      transform: scale(0.95);
      box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7);
    }
    70% {
      transform: scale(1);
      box-shadow: 0 0 0 8px rgba(22, 163, 74, 0);
    }
    100% {
      transform: scale(0.95);
      box-shadow: 0 0 0 0 rgba(22, 163, 74, 0);
    }
  }
  .active-pulse {
    animation: live-pulse 2s infinite;
    background: #16a34a;
    border-radius: 50%;
    width: 10px;
    height: 10px;
    display: inline-block;
    margin-right: 5px;
  }
</style>
