---
import fs from "node:fs";
import path from "node:path";
import { parse } from "csv-parse/sync";
import MainLayout from "../layouts/MainLayout.astro";
import { SITE_CONFIG } from "../config.js";
import { Image } from "astro:assets";
import premiumFaqs from "../data/premium-faqs.json";

export async function getStaticPaths() {
  const filePath = path.resolve("./src/data/cities.csv");
  const fileContent = fs.readFileSync(filePath, "utf-8");
  const records = parse(fileContent, { columns: true, skip_empty_lines: true, bom: true });

  const services = [
    { prefix: "tree-removal", name: "Tree Removal", icon: "ðŸŒ³" },
    { prefix: "stump-grinding", name: "Stump Grinding", icon: "ðŸ—ï¸" },
    { prefix: "emergency-service", name: "Emergency Tree Service", icon: "ðŸŒªï¸" },
  ];

  const paths = [];
  records.forEach((row) => {
    if (!row.City) return;
    const citySlug = row.City.toLowerCase().trim().replace(/\s+/g, "-");
    services.forEach((service) => {
      paths.push({
        params: { slug: `${service.prefix}-${citySlug}` },
        props: {
          cityData: row,
          serviceInfo: service,
          allServices: services, // Åžehir iÃ§i Ã§apraz linkleme iÃ§in
          nearby: records.filter((r) => r.County === row.County && r.City !== row.City).slice(0, 5),
        },
      });
    });
  });
  return paths;
}

const { cityData, serviceInfo, nearby, allServices } = Astro.props;

// Veri Formatlama
const cityName = cityData.City.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
const landmark = cityData.Landmark || "the local Florida landscape";
const countyName = cityData.County;

// Dinamik GÃ¶rsel SeÃ§imi
const serviceFolder = serviceInfo.prefix.includes("removal") ? "removal" : serviceInfo.prefix.includes("stump") ? "stump" : "emergency";
const allImages = import.meta.glob("../assets/gallery/fl/**/*.{jpeg,jpg,png,gif,webp}");
const imagePaths = Object.keys(allImages).filter((p) => p.includes(`/${serviceFolder}/`));

let selectedImage = null;
if (imagePaths.length > 0) {
  const imageIndex = Math.abs((cityName + serviceInfo.prefix).split("").reduce((a, b) => a + b.charCodeAt(0), 0)) % imagePaths.length;
  const imgModule: any = await allImages[imagePaths[imageIndex]]();
  selectedImage = imgModule.default;
}

// FAQ MantÄ±ÄŸÄ± (Åžehre Ã¶zel yoksa varsayÄ±lan)
const cityKey = cityData.City.toLowerCase().trim().replace(/\s+/g, "-");
let finalFaqs = premiumFaqs[cityKey] || [
    { q: `How much is ${serviceInfo.name} in ${cityName}?`, a: `Pricing for ${serviceInfo.name} in ${cityName} depends on the job size and proximity to structures like ${landmark}. Call for a free onsite quote.` },
    { q: `Are you available for emergencies in ${countyName} County?`, a: `Yes, we provide 24/7 priority dispatch for tree emergencies throughout ${cityName} and surrounding areas.` }
];
---

<MainLayout title={`#1 ${serviceInfo.name} ${cityName}, FL | Licensed & Insured`} description={`Need ${serviceInfo.name.toLowerCase()} in ${cityName}, FL? Professional tree care near ${landmark}. Licensed experts, free estimates, 24/7 service.`}>
  
  <!-- Breadcrumb & Service Schema -->
  <script type="application/ld+json" is:inline define:vars={{ cityName, serviceName: serviceInfo.name, countyName, siteUrl: SITE_CONFIG.siteUrl }}>
    {
      "@context": "https://schema.org",
      "@type": "Service",
      "name": serviceName + " in " + cityName,
      "provider": { "@type": "LocalBusiness", "name": "ProTreeTrimâ„¢ Florida" },
      "areaServed": [
        { "@type": "City", "name": cityName },
        { "@type": "AdministrativeArea", "name": countyName }
      ],
      "hasOfferCatalog": {
        "@type": "OfferCatalog",
        "name": "Tree Care",
        "itemListElement": [{ "@type": "Offer", "itemOffered": { "@type": "Service", "name": "Free Estimate" } }]
      }
    }
  </script>

  <header style="background: linear-gradient(135deg, #1b4332 0%, #081c15 100%); color: white; padding: 4rem 1.5rem; text-align: center; border-bottom: 5px solid #ea580c;">
    <div class="container">
      <h1 style="margin: 0; font-size: clamp(2rem, 7vw, 3.5rem); font-weight: 900; line-height: 1.1;">{cityName} {serviceInfo.name}</h1>
      <p style="font-size: 1.2rem; margin-top: 1rem; color: #95d5b2;">Trusted arboriculture near <strong>{landmark}</strong></p>
    </div>
  </header>

  <main class="container" style="max-width: 1000px; margin-top: -2rem;">
    <!-- CTA Card -->
    <div style="background: white; padding: 2.5rem 1.5rem; border-radius: 24px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.1); border: 1px solid #eee;">
      <h3 style="margin: 0 0 10px; color: #1b4332; font-size: 1.5rem; font-weight: 800;">Get Your Free Estimate</h3>
      <a href={SITE_CONFIG.phoneHref} style="color: #ea580c; text-decoration: none; font-size: 2.2rem; font-weight: 900; display: block;">{SITE_CONFIG.phone}</a>
    </div>

    <!-- Weather & Local Hub (Internal Linking Power) -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
      <!-- HÄ±zlandÄ±rÄ±lmÄ±ÅŸ Hava Durumu (Skeleton ile) -->
      <div style="background: white; padding: 1.5rem; border-radius: 20px; border: 1px solid #e2e8f0;">
        <h4 style="margin: 0 0 15px; color: #1b4332; font-size: 1rem;">{cityName} Conditions</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center;">
            <div style="background: #f8fafc; padding: 10px; border-radius: 12px;">
                <span id="temp" class="loading-pulse" style="display:block; font-size: 1.2rem; font-weight: 800;">00Â°F</span>
                <small style="font-size: 0.6rem; opacity: 0.7; font-weight: 700;">TEMP</small>
            </div>
            <div style="background: #f8fafc; padding: 10px; border-radius: 12px;">
                <span id="wind" class="loading-pulse" style="display:block; font-size: 1.2rem; font-weight: 800;">0mph</span>
                <small style="font-size: 0.6rem; opacity: 0.7; font-weight: 700;">WIND</small>
            </div>
            <div style="background: #f8fafc; padding: 10px; border-radius: 12px;">
                <span id="cond" class="loading-pulse" style="display:block; font-size: 1.1rem; font-weight: 800;">---</span>
                <small style="font-size: 0.6rem; opacity: 0.7; font-weight: 700;">SKIES</small>
            </div>
        </div>
      </div>

      <!-- City Link Hub (Ã‡apraz Linkleme) -->
      <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 20px; border: 1px solid #dcfce7;">
        <h4 style="margin: 0 0 10px; color: #166534; font-size: 1rem;">Also Available in {cityName}:</h4>
        <div style="display: flex; flex-direction: column; gap: 8px;">
            {allServices.filter(s => s.name !== serviceInfo.name).map(s => (
                <a href={`/${s.prefix}-${cityData.City.toLowerCase().replace(/\s+/g, '-')}`} style="color: #1b4332; text-decoration: none; font-size: 0.9rem; font-weight: 700;">
                    {s.icon} {s.name} Service â†’
                </a>
            ))}
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <section style="margin-top: 50px; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 40px; align-items: center;">
        <div>
            <h2 style="color: #1b4332; font-size: 1.8rem; font-weight: 800;">Expert {serviceInfo.name} in {cityName}</h2>
            <p style="line-height: 1.8; color: #4b5563; font-size: 1.05rem;">{cityData.Description}</p>
            <p style="line-height: 1.8; color: #4b5563;">Located near <strong>{landmark}</strong>, our teams are fully equipped for the unique challenges of the {countyName} County landscape.</p>
        </div>
        {selectedImage && (
            <div style="position: relative;">
                <Image src={selectedImage} alt={`${serviceInfo.name} in ${cityName} FL near ${landmark}`} width={600} height={400} style="width:100%; height:auto; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);" />
                <div style="position: absolute; bottom: 15px; right: 15px; background: #ea580c; color: white; padding: 6px 14px; border-radius: 50px; font-size: 0.7rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px;">âœ“ Verified Local Crew</div>
            </div>
        )}
    </section>

    <!-- FAQ Section -->
    <section style="margin: 80px 0;">
        <h2 style="text-align: center; color: #1b4332; margin-bottom: 40px; font-weight: 900;">Common Questions in {cityName}</h2>
        <div style="display: grid; gap: 15px; max-width: 800px; margin: 0 auto;">
            {finalFaqs.map(f => (
                <div style="background: white; padding: 1.5rem; border-radius: 18px; border: 1px solid #eee; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
                    <p style="margin: 0 0 8px; font-weight: 800; color: #1b4332; font-size: 1.1rem;">{f.q}</p>
                    <p style="margin: 0; color: #64748b; font-size: 1rem; line-height: 1.6;">{f.a}</p>
                </div>
            ))}
        </div>
    </section>

    <!-- Surrounding Cities (Internal Linking) -->
    <section style="margin-bottom: 120px; text-align: center; border-top: 1px solid #eee; padding-top: 50px;">
        <p style="font-weight: 800; color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;">Serving Surrounding {countyName} County Areas:</p>
        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px;">
            {nearby.map(n => (
                <a href={`/tree-removal-${n.City.toLowerCase().replace(/\s+/g, '-')}`} style="background: white; border: 1px solid #e2e8f0; padding: 10px 20px; border-radius: 50px; text-decoration: none; color: #4b5563; font-size: 0.85rem; font-weight: 700; transition: 0.2s;" class="nearby-hover">
                    {n.City} Tree Care
                </a>
            ))}
        </div>
    </section>
  </main>

  <script is:inline define:vars={{ rawCityName: cityData.City }}>
    async function updateWeather() {
      try {
        const res = await fetch(`https://wttr.in/${rawCityName},Florida?format=j1`);
        const data = await res.json();
        const cur = data.current_condition[0];
        
        const tempEl = document.getElementById('temp');
        const windEl = document.getElementById('wind');
        const condEl = document.getElementById('cond');

        tempEl.innerText = cur.temp_F + 'Â°F';
        windEl.innerText = cur.windspeedMiles + 'mph';
        condEl.innerText = cur.weatherDesc[0].value.split(' ')[0];

        // Animasyonu kaldÄ±r
        [tempEl, windEl, condEl].forEach(el => el.classList.remove('loading-pulse'));
      } catch (e) {
        console.error("Weather failed");
      }
    }
    updateWeather();
  </script>
</MainLayout>

<style>
    .nearby-hover:hover { border-color: #ea580c !important; color: #ea580c !important; transform: translateY(-2px); }
</style>