---
import fs from "node:fs";
import path from "node:path";
import { parse } from "csv-parse/sync";
import MainLayout from "../layouts/MainLayout.astro";
import { SITE_CONFIG } from "../config.js";
import { Image } from "astro:assets";
import premiumFaqs from "../data/premium-faqs.json";
import arboristTips from "../data/arborist-tips.json";
import PriceCalculator from "../components/PriceCalculator.astro"; // YENƒ∞ IMPORT

// Zengin i√ßerik JSON dosyalarƒ±
import cityEmergency from "../data/city-emergency.json";
import cityRemoval from "../data/city-removal.json";
import cityStump from "../data/city-stump.json";

export async function getStaticPaths() {
  const filePath = path.resolve("./src/data/cities.csv");
  const fileContent = fs.readFileSync(filePath, "utf-8");
  const records = parse(fileContent, {
    columns: true,
    skip_empty_lines: true,
    bom: true,
  });

  const services = [
    { prefix: "tree-removal", name: "Tree Removal", icon: "üå≥" },
    { prefix: "stump-grinding", name: "Stump Grinding", icon: "üèóÔ∏è" },
    { prefix: "emergency-service", name: "Emergency Tree Service", icon: "üå™Ô∏è" },
  ];

  const paths = [];
  records.forEach((row) => {
    if (!row.City) return;
    const citySlug = row.City.toLowerCase()
      .trim()
      .replace(/\./g, "")
      .replace(/\s+/g, "-");

    services.forEach((service) => {
      paths.push({
        params: { slug: `${service.prefix}-${citySlug}` },
        props: {
          cityData: row,
          serviceInfo: service,
          allServices: services,
          nearby: records
            .filter((r) => r.County === row.County && r.City !== row.City)
            .slice(0, 5),
        },
      });
    });
  });
  return paths;
}

const { cityData, serviceInfo, nearby, allServices } = Astro.props;

const toTitleCase = (str) => {
  if (!str) return "";
  return str
    .toLowerCase()
    .split(" ")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
};

const cityName = toTitleCase(cityData.City);
const landmark = toTitleCase(cityData.Landmark) || "the local area";
const countyName = toTitleCase(cityData.County);
const mainTree = cityData.MainTreeType || "local Florida trees";

const citySlugClean = cityData.City.toLowerCase()
  .trim()
  .replace(/\./g, "")
  .replace(/\s+/g, "-");

const tipIndex =
  (cityData.City.length + cityData.Landmark.length) % arboristTips.length;
const selectedTemplate = arboristTips[tipIndex];
const finalDynamicTip = selectedTemplate
  .replaceAll("[City]", cityName)
  .replaceAll("[Landmark]", landmark)
  .replaceAll("[MainTreeType]", mainTree)
  .replaceAll(
    "[FocusService]",
    cityData.FocusService || "professional tree care",
  );

const cityTemplates = [
  `In ${cityName}, our tree operations are defined by high-angle rigging precision and an uncompromising focus on safety. For projects located near ${landmark}, our certified teams evaluate the specific structural needs of ${mainTree}, ensuring that every ${serviceInfo.name} or hazard mitigation task aligns with the latest ISA standards. By accounting for the unique wind-load dynamics of ${countyName} County, we provide local property owners with a service that protects both their structures and the long-term vitality of the surrounding landscape.`,
  `The Florida climate in ${cityName} presents unique challenges for native vegetation, especially species like ${mainTree}. Our crews, active throughout ${countyName} County and specifically near ${landmark}, utilize advanced technical pruning to mitigate storm risks before they escalate. We don't just perform ${serviceInfo.name}; we build a comprehensive property plan that accounts for local soil saturation and coastal gust patterns, ensuring your ${cityName} residence remains hazard-free throughout the year.`,
  `Residents near ${landmark} understand the value of a well-maintained canopy. In ${cityName}, our dispatch network specializes in managing complex ${mainTree} projects where property lines and structures are in close proximity. From precision ${serviceInfo.name} to urgent hazard removal, we bring deep ${countyName} County environmental knowledge to every job site. Our goal is simple: providing ${cityName} with elite arborist expertise that enhances curb appeal while prioritizing the safety of your home.`,
  `Professionalism in ${countyName} County tree care requires a balance of biological science and modern engineering. In ${cityName}, we connect you with vetted specialists who understand the complex growth habits of ${mainTree} near ${landmark}. Whether you require a routine ${serviceInfo.name} or a technical canopy reduction, our operations strictly follow safety regulations designed for the unique Florida terrain. We ensure that every landscape in ${cityName} we service is better prepared for environmental stress.`,
];

const templateChoiceIndex =
  Math.abs(cityName.split("").reduce((a, b) => a + b.charCodeAt(0), 0)) %
  cityTemplates.length;

// Hƒ∞ZMET T√úR√úNE G√ñRE ZENGƒ∞N METƒ∞N SE√áƒ∞Mƒ∞
let selectedRichText = "";
if (serviceInfo.prefix === "tree-removal") {
  selectedRichText =
    cityRemoval[citySlugClean] || cityTemplates[templateChoiceIndex];
} else if (serviceInfo.prefix === "stump-grinding") {
  selectedRichText =
    cityStump[citySlugClean] || cityTemplates[templateChoiceIndex];
} else if (serviceInfo.prefix === "emergency-service") {
  selectedRichText =
    cityEmergency[citySlugClean] || cityTemplates[templateChoiceIndex];
} else {
  selectedRichText = cityTemplates[templateChoiceIndex];
}

const serviceFolder = serviceInfo.prefix.includes("removal")
  ? "removal"
  : serviceInfo.prefix.includes("stump")
    ? "stump"
    : "emergency";
const allImages = import.meta.glob(
  "../assets/gallery/fl/**/*.{jpeg,jpg,png,gif,webp}",
);
const imagePaths = Object.keys(allImages).filter((p) =>
  p.includes(`/${serviceFolder}/`),
);

let selectedImage = null;
if (imagePaths.length > 0) {
  const imageIndex =
    Math.abs(
      (cityName + serviceInfo.prefix)
        .split("")
        .reduce((a, b) => a + b.charCodeAt(0), 0),
    ) % imagePaths.length;
  const imgModule: any = await allImages[imagePaths[imageIndex]]();
  selectedImage = imgModule.default;
}

const cityKey = cityData.City.toLowerCase()
  .trim()
  .replace(/\./g, "")
  .replace(/\s+/g, "-");
const fallbackFaqs = [
  {
    q: `Do I need a permit for ${serviceInfo.name} in ${cityName}?`,
    a: `Under Florida Statute 163.045, residential property owners in ${cityName} can often remove hazardous trees without local permits if a certified professional documents the threat. For non-emergency work near ${landmark}, we recommend verifying specific ${countyName} County ordinances.`,
  },
];
let finalFaqs = premiumFaqs[cityKey] || fallbackFaqs;

// BA≈ûLIK √áE≈ûƒ∞TLENDƒ∞RME MANTIƒûI
const titleTemplates = [
  `#1 ${serviceInfo.name} in ${cityName}, FL | Licensed & Insured`,
  `Expert ${serviceInfo.name} ${cityName} | 24/7 Emergency Service`,
  `Top Rated ${serviceInfo.name} in ${cityName} | Free Estimates`,
  `Trusted ${serviceInfo.name} Specialists: ${cityName}, FL`,
  `Affordable ${serviceInfo.name} in ${cityName} | ProTreeTrim‚Ñ¢`,
];
const titleIndex = Math.abs(cityName.length + serviceInfo.name.length) % titleTemplates.length;
const finalPageTitle = titleTemplates[titleIndex];

// RESIDENTIAL FOCUS MANTIƒûI
const residentialTemplates = [
  `For residential gardens in ${cityName}, we prioritize zero-impact removal techniques. Our crews use specialized matting to protect your lawn and decorative pavers while dismantling ${mainTree} near structures.`,
  `Backyard tree projects near ${landmark} require precision. We specialize in tight-access removals, ensuring that your garden beds and irrigation lines remain undisturbed throughout the ${serviceInfo.name} process.`,
  `Managing ${mainTree} in a residential setting in ${cityName} is about safety and aesthetics. Our local teams focus on clean execution, ensuring your backyard remains a safe haven after the job is done.`,
  `Homeowners in the ${countyName} County area trust us for delicate garden tree care. Whether it's a century-old oak or a complex palm structure, we use advanced rigging to bypass your delicate landscaping features.`,
  `Safety for your family and garden is our primary concern. In ${cityName}, we perform ${serviceInfo.name} using lightweight equipment that leaves no ruts in your lawn, even in high-moisture Florida soils.`
];
const resIndex = Math.abs(cityName.length - serviceInfo.name.length) % residentialTemplates.length;
const selectedResidentialNote = residentialTemplates[resIndex];

const seed = cityName.length + countyName.length;
const activeCrews = (seed % 5) + 3; 
const avgResponse = (seed % 15) + 25;

const nearbyCitiesList = cityData.NearbyCities || "";
const serviceAreaNote = `Our strategic dispatch model ensures that while we are focused on ${cityName}, our crews also maintain a rapid response presence in ${nearbyCitiesList} and the greater ${countyName} County region. This geographic spread allows us to manage ${mainTree} maintenance projects for both residential gardens and commercial properties near ${landmark} with minimal lead times.`;
---

<MainLayout title={finalPageTitle} description={cityData.Description}>
  
  <!-- SEO SCHEMA START -->
  <script type="application/ld+json" slot="head" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "BreadcrumbList",
        "itemListElement": [
          {
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": SITE_CONFIG.siteUrl
          },
          {
            "@type": "ListItem",
            "position": 2,
            "name": "Florida",
            "item": SITE_CONFIG.siteUrl
          },
          {
            "@type": "ListItem",
            "position": 3,
            "name": cityName,
            "item": `${SITE_CONFIG.siteUrl}/tree-removal-${citySlugClean}`
          },
          {
            "@type": "ListItem",
            "position": 4,
            "name": serviceInfo.name,
            "item": `${SITE_CONFIG.siteUrl}/${Astro.params.slug}`
          }
        ]
      },
      {
        "@type": "Service",
        "name": `${serviceInfo.name} in ${cityName}, FL`,
        "description": cityData.Description,
        "provider": {
          "@type": "LocalBusiness",
          "name": SITE_CONFIG.brandName,
          "image": "https://www.protreetrim.com/team.jpg",
          "telephone": SITE_CONFIG.phoneHref.replace("tel:", "")
        },
        "areaServed": {
          "@type": "City",
          "name": cityName
        },
        "hasOfferCatalog": {
          "@type": "OfferCatalog",
          "name": "Tree Care Services",
          "itemListElement": [
            {
              "@type": "Offer",
              "itemOffered": {
                "@type": "Service",
                "name": serviceInfo.name
              }
            }
          ]
        }
      },
      {
        "@type": "FAQPage",
        "mainEntity": finalFaqs.map(faq => ({
          "@type": "Question",
          "name": faq.q,
          "acceptedAnswer": {
            "@type": "Answer",
            "text": faq.a
          }
        }))
      }
    ]
  })} />
  <!-- SEO SCHEMA END -->

  <!-- HEADER -->
  <header
    style="background: linear-gradient(135deg, #1b4332 0%, #081c15 100%); color: white; padding: 4.5rem 1.5rem; text-align: center; border-bottom: 5px solid #ea580c;"
  >
    <div class="container">
      <div
        style="font-size: 0.85rem; margin-bottom: 1rem; color: #ffb703; font-weight: 800; text-transform: uppercase;"
      >
        Official Service Dispatch ‚Ä¢ {countyName} County
      </div>
      <h1
        style="margin: 0; font-size: clamp(2rem, 7vw, 3.5rem); font-weight: 900; line-height: 1.1;"
      >
        {cityName}
        {serviceInfo.name}
      </h1>
      <p
        style="font-size: 1.25rem; margin-top: 1.2rem; color: #95d5b2; max-width: 750px; margin-left: auto; margin-right: auto;"
      >
        Providing elite care for properties near <strong>{landmark}</strong>.
      </p>
    </div>
  </header>

  <!-- BREADCRUMB NAVIGATION -->
  <nav class="breadcrumb-nav">
    <div class="container">
      <ol class="breadcrumb-list">
        <li><a href="/">Home</a></li>
        <li><a href="/">Florida</a></li>
        <li><a href={`/tree-removal-${citySlugClean}`}>{cityName}</a></li>
        <li class="active">{serviceInfo.name}</li>
      </ol>
    </div>
  </nav>

  <main
    class="container"
    style="max-width: 1100px; margin: 1.5rem auto 0; padding: 0 1rem; position: relative; z-index: 10;"
  >
    <!-- HERO CTA BOX -->
    <div
      style="background: white; padding: 2.5rem 1.5rem; border-radius: 24px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.1); border: 1px solid #eee;"
    >
      <h3
        style="margin: 0 0 10px; color: #064e3b; font-size: 1.6rem; font-weight: 800;"
      >
        Instant Professional Estimate
      </h3>
      <p style="color: #6b7280; margin-bottom: 1.5rem; font-size: 1rem;">
        Connect with verified {serviceInfo.name} specialists in {cityName}.
      </p>
      <a
        href={SITE_CONFIG.phoneHref}
        style="background: #ea580c; color: white !important; padding: 1.2rem; text-decoration: none; border-radius: 12px; font-weight: 900; font-size: clamp(1.4rem, 5vw, 2.2rem); display: block; box-shadow: 0 10px 25px rgba(234, 88, 12, 0.3); transition: 0.3s;"
        >{SITE_CONFIG.phone}</a
      >
      
      <!-- Dƒ∞NAMƒ∞K ƒ∞STATƒ∞STƒ∞K ≈ûERƒ∞Dƒ∞ -->
      <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px; border-top: 1px solid #f1f5f9; padding-top: 20px; flex-wrap: wrap;">
         <div style="text-align: left;"><small style="display:block; color:#94a3b8; font-weight:700; font-size:0.65rem; text-transform:uppercase;">Active Crews</small><span style="font-weight:800; color:#1b4332;">{activeCrews} Specialists</span></div>
         <div style="text-align: left;"><small style="display:block; color:#94a3b8; font-weight:700; font-size:0.65rem; text-transform:uppercase;">Avg Response</small><span style="font-weight:800; color:#1b4332;">{avgResponse} Mins</span></div>
         <div style="text-align: left;"><small style="display:block; color:#94a3b8; font-weight:700; font-size:0.65rem; text-transform:uppercase;">Availability</small><span style="font-weight:800; color:#16a34a;">24/7 Dispatch</span></div>
      </div>
      
      <p
        style="margin-top: 12px; font-size: 0.75rem; font-weight: 800; color: #1b4332; text-transform: uppercase; letter-spacing: 0.5px;"
      >
        100% Free - No Obligation Estimate
      </p>
    </div>

    <!-- STEPS -->
    <section style="margin-top: 4rem;">
      <h2
        style="color: #064e3b; font-size: 1.8rem; font-weight: 900; text-align: center; margin-bottom: 2rem;"
      >
        3 Simple Steps to Service
      </h2>
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;"
      >
        <div class="info-card-base step-card">
          <div class="icon-box" style="background: #e0f2fe;">üìû</div><h4>
            1. Call Dispatch
          </h4><p>Connect with our office instantly.</p>
        </div>
        <div class="info-card-base step-card">
          <div class="icon-box" style="background: #fef3c7;">üìã</div><h4>
            2. Get a Quote
          </h4><p>A local specialist provides a transparent assessment.</p>
        </div>
        <div class="info-card-base step-card">
          <div class="icon-box" style="background: #dcfce7;">‚úÖ</div><h4>
            3. Job Completed
          </h4><p>Safe execution and thorough cleanup of your property.</p>
        </div>
      </div>
    </section>

    <!-- MONITOR & HUB -->
    <section
      style="margin-top: 3.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;"
    >
      <div class="info-card-base">
        <div
          style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;"
        >
          <div>
            <span
              style="background: #1b4332; color: #ffb703; font-size: 0.65rem; padding: 4px 12px; border-radius: 50px; font-weight: 800; text-transform: uppercase;"
              >Local Authority Monitor</span
            >
            <h4
              style="margin: 8px 0 0; color: #1e293b; font-size: 1.15rem; font-weight: 800;"
            >
              {cityName} Service Status
            </h4>
          </div>
          <div style="text-align: right;">
            <div id="live-dot" class="active-pulse"></div><span
              style="font-size: 0.75rem; font-weight: 900; color: #16a34a;"
              >Active</span
            >
          </div>
        </div>

        <!-- WEATHER WIDGET -->
        <div
          id="weather-widget"
          data-city={cityName}
          style="display: flex; justify-content: space-between; gap: 10px; margin: 15px 0; background: #fff; padding: 10px; border-radius: 15px; border: 1px solid #f1f5f9; min-height: 70px;"
        >
          <div
            style="font-size: 0.8rem; color: #94a3b8; display: flex; align-items: center; justify-content: center; width: 100%;"
          >
            Loading {cityName} weather...
          </div>
        </div>

        <div
          style="background: #f8fafc; padding: 15px; border-radius: 18px; border: 1px solid #f1f5f9; margin: 10px 0;"
        >
          <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"
          >
            <span
              id="current-date"
              style="font-size: 0.95rem; font-weight: 800; color: #1b4332;"
              >--/--/2026</span
            ><span style="font-size: 1.3rem;">üìÖ</span>
          </div>
          <p
            style="margin: 0; font-size: 0.9rem; color: #4b5563; line-height: 1.5; font-weight: 700; font-style: italic;"
          >
            {finalDynamicTip}
          </p>
        </div>
      </div>

      <div
        style="background: #f0fdf4; padding: 1.8rem; border-radius: 24px; border: 1px solid #dcfce7; display: flex; flex-direction: column; justify-content: center;"
      >
        <h4
          style="margin: 0 0 15px; color: #166534; font-size: 1.15rem; font-weight: 800;"
        >
          Local Service Hub
        </h4>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          {
            allServices
              .filter((s) => s.name !== serviceInfo.name)
              .map((s) => (
                <a href={`/${s.prefix}-${citySlugClean}`} class="hub-link-item">
                  <span>{s.icon}</span> {s.name} in {cityName} ‚Üí
                </a>
              ))
          }
        </div>
      </div>
    </section>

    <!-- STATUS STRIP -->
    <section
      style="margin-top: 2rem; background: #064e3b; color: white; padding: 2rem; border-radius: 24px; display: flex; flex-wrap: wrap; justify-content: space-around; gap: 20px; align-items: center; border: 1px solid #1b4332;"
    >
      <div style="text-align: center;">
        <p
          style="margin: 0; color: #95d5b2; font-size: 0.75rem; font-weight: 800; text-transform: uppercase;"
        >
          Service Area
        </p>
        <p
          style="margin: 5px 0 0; font-weight: 900; font-size: 1.1rem; color: #ffffff;"
        >
          {countyName} County
        </p>
      </div>
      <div class="status-item-middle">
        <p
          style="margin: 0; color: #95d5b2; font-size: 0.75rem; font-weight: 800; text-transform: uppercase;"
        >
          Local Landmark
        </p>
        <p
          style="margin: 5px 0 0; font-weight: 900; font-size: 1.1rem; color: #ffffff;"
        >
          {landmark}
        </p>
      </div>
      <div style="text-align: center;">
        <p
          style="margin: 0; color: #95d5b2; font-size: 0.75rem; font-weight: 800; text-transform: uppercase;"
        >
          Dispatch Status
        </p>
        <p
          style="margin: 5px 0 0; font-weight: 900; font-size: 1.1rem; color: #4ade80;"
        >
          ‚óè Active in {cityName}
        </p>
      </div>
    </section>

    <!-- ‚Üì‚Üì‚Üì YENƒ∞: PRICE CALCULATOR INTEGRATION ‚Üì‚Üì‚Üì -->
    <PriceCalculator city={cityName} />
    <!-- ‚Üë‚Üë‚Üë YENƒ∞: PRICE CALCULATOR INTEGRATION ‚Üë‚Üë‚Üë -->

    <!-- RICH TEXT & IMAGE -->
    <section style="margin-top: 5rem;">
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; align-items: center;"
      >
        <div>
          <h2
            style="color: #064e3b; font-size: 1.8rem; font-weight: 900; margin-bottom: 1.5rem;"
          >
            Expert {serviceInfo.name} in {cityName}
          </h2>
          
          <!-- RESIDENTIAL FOCUS PARAGRAFI -->
          <p style="font-size: 1.1rem; color: #1b4332; line-height: 1.8; font-weight: 700; background: #f0fdf4; padding: 15px; border-radius: 12px; border-left: 4px solid #16a34a; margin-bottom: 1.5rem;">
             {selectedResidentialNote}
          </p>

          <p
            style="font-size: 1.1rem; color: #4b5563; line-height: 1.8; margin-top: 1rem;"
          >
            {selectedRichText}
          </p>
        </div>
        {
          selectedImage && (
            <div style="position: relative;">
              <Image
                src={selectedImage}
                alt={`${serviceInfo.name} project near ${landmark} in ${cityName} Florida`}
                width={600}
                height={450}
                format="webp"
                style="width: 100%; height: auto; border-radius: 24px; box-shadow: 0 15px 30px rgba(0,0,0,0.1);"
              />
              <!-- G√ñRSEL ALT YAZISI -->
              <div style="position: absolute; bottom: 15px; left: 15px; right: 15px; background: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 12px; font-size: 0.8rem; backdrop-filter: blur(5px); font-weight: 600;">
                Recent {serviceInfo.name.toLowerCase()} work completed near {landmark} in {cityName}.
              </div>
            </div>
          )
        }
      </div>
    </section>

    <!-- SOCIAL PROOF & FAQ -->
    <section style="margin-top: 6rem;">
      <div
        style="margin-bottom: 1.5rem; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px; background: #fffbeb; padding: 12px; border-radius: 50px; border: 1px solid #fef3c7;"
      >
        <div
          class="active-pulse"
          style="width: 8px; height: 8px; background: #ea580c;"
        >
        </div>
        <p
          style="margin: 0; font-size: 0.95rem; color: #1b4332; font-weight: 800; letter-spacing: -0.2px;"
        >
          Last service request in <span style="color:#ea580c;">{cityName}</span> was
          <span id="last-request-time">...</span> hours ago.
        </p>
      </div>

      <h2
        style="color: #064e3b; font-size: 2.2rem; font-weight: 900; text-align: center; margin-bottom: 3rem;"
      >
        Common Questions in {cityName}
      </h2>
      <div style="display: flex; flex-direction: column; gap: 20px;">
        {
          finalFaqs.map((f) => (
            <div style="background: white; padding: 2.5rem; border-radius: 28px; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
              <h4 style="color: #1b4332; font-weight: 800; margin: 0 0 10px; font-size: 1.3rem;">
                {f.q}
              </h4>
              <p style="color: #4b5563; line-height: 1.8; margin: 0; font-size: 1.1rem;">
                {f.a}
              </p>
            </div>
          ))
        }
      </div>
    </section>

    <!-- DYNAMIC CITY MAP -->
    <section
      style="margin-top: 6rem; border-top: 1px solid #eee; padding-top: 4rem;"
    >
      <h2
        style="color: #064e3b; font-size: 1.8rem; font-weight: 900; text-align: center; margin-bottom: 2rem;"
      >
        Service Coverage: {cityName}, {countyName} County
      </h2>
      <div
        style="overflow: hidden; border-radius: 24px; border: 1px solid #e2e8f0; line-height: 0; box-shadow: 0 10px 30px rgba(0,0,0,0.05);"
      >
        <iframe
          width="100%"
          height="400"
          style="border:0"
          loading="lazy"
          allowfullscreen
          src={`https://maps.google.com/maps?q=${cityName},${countyName},FL&t=&z=12&ie=UTF8&iwloc=&output=embed`}
        ></iframe>
      </div>
    </section>

    <!-- REGIONAL LOGISTICS BLOCK -->
    <section style="margin-top: 4rem; padding: 2.5rem; background: #f8fafc; border-radius: 24px; border: 1px solid #e2e8f0; box-shadow: 0 10px 20px rgba(0,0,0,0.02);">
        <h3 style="color: #1b4332; font-size: 1.5rem; font-weight: 900; margin-bottom: 1.2rem; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.8rem;">üìç</span> Regional Service Area Information
        </h3>
        <p style="color: #4b5563; line-height: 1.8; font-size: 1.1rem; font-weight: 500; margin: 0;">
            {serviceAreaNote}
        </p>
    </section>

    <!-- NEARBY LINKS -->
    <section
      style="margin-top: 6rem; margin-bottom: 12rem; border-top: 1px solid #eee; padding-top: 4rem;"
    >
      <h3
        style="color: #064e3b; font-size: 1.3rem; font-weight: 800; margin-bottom: 2rem; text-align: center;"
      >
        Other Local Dispatch Areas in {countyName} County:
      </h3>
      <div
        style="display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;"
      >
        {
          nearby.map((n: any) => (
            <a
              href={`/tree-removal-${n.City.toLowerCase().trim().replace(/\./g, "").replace(/\s+/g, "-")}`}
              class="nearby-link"
            >
              {toTitleCase(n.City)} Tree Service
            </a>
          ))
        }
      </div>
    </section>
  </main>

  <script is:inline>
    function runCommonScripts() {
      const now = new Date();
      const dateEl = document.getElementById("current-date");
      if (dateEl)
        dateEl.innerText = now.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });

      const timeEl = document.getElementById("last-request-time");
      if (timeEl) timeEl.innerText = Math.floor(Math.random() * 8) + 2;
    }

    async function loadWeather() {
      const widget = document.getElementById("weather-widget");
      if (!widget) return;
      const cityName = widget.getAttribute("data-city");
      try {
        const geoRes = await fetch(
          `https://geocoding-api.open-meteo.com/v1/search?name=${cityName}&count=1&language=en&format=json`,
        );
        const geoData = await geoRes.json();
        if (geoData.results) {
          const { latitude, longitude } = geoData.results[0];
          const weatherRes = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weathercode,temperature_2m_max&temperature_unit=fahrenheit&timezone=auto`,
          );
          const weatherData = await weatherRes.json();
          const icons = {
            0: "‚òÄÔ∏è",
            1: "üå§Ô∏è",
            2: "‚õÖ",
            3: "‚òÅÔ∏è",
            45: "üå´Ô∏è",
            51: "üåßÔ∏è",
            61: "üåßÔ∏è",
            80: "üå¶Ô∏è",
            95: "‚õàÔ∏è",
          };
          let html = "";
          for (let i = 0; i < 3; i++) {
            const day =
              i === 0
                ? "Today"
                : new Date(weatherData.daily.time[i]).toLocaleDateString(
                    "en-US",
                    { weekday: "short" },
                  );
            const temp = Math.round(weatherData.daily.temperature_2m_max[i]);
            html += `<div style="text-align: center; flex: 1;"><div style="font-size: 0.6rem; font-weight: 800; color: #94a3b8; text-transform: uppercase;">${day}</div><div style="font-size: 1.2rem; margin: 2px 0;">${icons[weatherData.daily.weathercode[i]] || "‚õÖ"}</div><div style="font-size: 0.85rem; font-weight: 900; color: #1e293b;">${temp}¬∞F</div></div>`;
          }
          widget.innerHTML = html;
        }
      } catch (e) {
        widget.innerHTML = `<div style="font-size: 0.75rem; color: #94a3b8;">Weather update unavailable</div>`;
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      runCommonScripts();
      loadWeather();
    });
  </script>
</MainLayout>

<style>
  /* BREADCRUMB STYLES */
  .breadcrumb-nav {
    background: #f8fafc;
    padding: 12px 0;
    border-bottom: 1px solid #e2e8f0;
  }
  .breadcrumb-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    font-size: 0.8rem;
    font-weight: 700;
    color: #64748b;
    text-transform: uppercase;
  }
  .breadcrumb-list li {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .breadcrumb-list li:not(:last-child)::after {
    content: "/";
    color: #cbd5e1;
    font-weight: 400;
  }
  .breadcrumb-list a {
    color: #1b4332;
    text-decoration: none;
    transition: 0.2s;
  }
  .breadcrumb-list a:hover {
    color: #ea580c;
  }
  .breadcrumb-list li.active {
    color: #94a3b8;
  }

  .info-card-base {
    background: white;
    padding: 2.5rem;
    border-radius: 24px;
    border: 1px solid #eee;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.03);
  }
  .step-card {
    text-align: center;
  }
  .icon-box {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.6rem;
    margin-bottom: 1.5rem;
  }
  .step-card .icon-box {
    margin-left: auto;
    margin-right: auto;
  }
  h4 {
    font-weight: 900;
    margin: 0 0 12px;
    color: #1b4332;
  }
  p {
    font-size: 0.95rem;
    color: #4b5563;
    line-height: 1.6;
    margin: 0;
  }
  .hub-link-item {
    color: #1b4332;
    text-decoration: none;
    font-size: 0.95rem;
    font-weight: 700;
    display: flex;
    align-items: center; gap: 10px;
    transition: 0.2s;
    margin-bottom: 5px;
  }
  .hub-link-item:hover {
    color: #ea580c;
    transform: translateX(5px);
  }
  .nearby-link {
    background: white;
    color: #166534;
    padding: 10px 20px;
    border-radius: 50px;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 700;
    border: 1px solid #e2e8f0;
    transition: 0.2s;
  }
  .nearby-link:hover {
    background: #f0fdf4 !important;
    border-color: #166534 !important;
    transform: translateY(-2px);
  }
  @keyframes live-pulse {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 8px rgba(22, 163, 74, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); }
  }
  .active-pulse {
    animation: live-pulse 2s infinite;
    background: #16a34a;
    border-radius: 50%;
    width: 10px;
    height: 10px;
    display: inline-block;
    margin-right: 5px;
  }
  .status-item-middle {
    text-align: center;
    padding: 0 2rem;
  }
  @media (min-width: 768px) {
    .status-item-middle {
      border-left: 1px solid rgba(255, 255, 255, 0.1);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }
  }
</style>