---
import fs from "node:fs";
import path from "node:path";
import { parse } from "csv-parse/sync";
import MainLayout from "../layouts/MainLayout.astro";
import { SITE_CONFIG } from "../config.js";
import { Image } from "astro:assets";
import premiumFaqs from "../data/premium-faqs.json";
import arboristTips from "../data/arborist-tips.json";

export async function getStaticPaths() {
  const filePath = path.resolve("./src/data/cities.csv");
  const fileContent = fs.readFileSync(filePath, "utf-8");
  const records = parse(fileContent, {
    columns: true,
    skip_empty_lines: true,
    bom: true,
  });

  const services = [
    { prefix: "tree-removal", name: "Tree Removal", icon: "ðŸŒ³" },
    { prefix: "stump-grinding", name: "Stump Grinding", icon: "ðŸ—ï¸" },
    { prefix: "emergency-service", name: "Emergency Tree Service", icon: "ðŸŒªï¸" },
  ];

  const paths = [];
  records.forEach((row) => {
    if (!row.City) return;
    const citySlug = row.City.toLowerCase().trim().replace(/\./g, "").replace(/\s+/g, "-");
    
    services.forEach((service) => {
      paths.push({
        params: { slug: `${service.prefix}-${citySlug}` },
        props: {
          cityData: row,
          serviceInfo: service,
          allServices: services,
          nearby: records
            .filter((r) => r.County === row.County && r.City !== row.City)
            .slice(0, 5),
        },
      });
    });
  });
  return paths;
}

const { cityData, serviceInfo, nearby, allServices } = Astro.props;

const toTitleCase = (str) => {
  if (!str) return "";
  return str
    .toLowerCase()
    .split(" ")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
};

const cityName = toTitleCase(cityData.City);
const landmark = toTitleCase(cityData.Landmark) || "the local area";
const countyName = toTitleCase(cityData.County);
const currentUrl = new URL(Astro.url.pathname, SITE_CONFIG.siteUrl).toString();

// â˜… SÃœPER BENZERSÄ°ZLEÅžTÄ°RÄ°CÄ° MANTIÄžI (Korundu)
const tipIndex = Math.abs((cityData.City + cityData.Landmark + serviceInfo.prefix).split('').reduce((a, b) => a + b.charCodeAt(0), 0)) % arboristTips.length;
const selectedTemplate = arboristTips[tipIndex];

const finalDynamicTip = selectedTemplate
  .replaceAll("[City]", cityName)
  .replaceAll("[Landmark]", landmark)
  .replaceAll("[MainTreeType]", cityData.MainTreeType || "local trees")
  .replaceAll("[FocusService]", cityData.FocusService || "professional tree care");

const serviceFolder = serviceInfo.prefix.includes("removal") ? "removal" : serviceInfo.prefix.includes("stump") ? "stump" : "emergency";
const allImages = import.meta.glob("../assets/gallery/fl/**/*.{jpeg,jpg,png,gif,webp}");
const imagePaths = Object.keys(allImages).filter((p) => p.includes(`/${serviceFolder}/`));

let selectedImage = null;
if (imagePaths.length > 0) {
  const imageIndex = Math.abs((cityName + serviceInfo.prefix).split("").reduce((a, b) => a + b.charCodeAt(0), 0)) % imagePaths.length;
  const imgModule: any = await allImages[imagePaths[imageIndex]]();
  selectedImage = imgModule.default;
}

const cityKey = cityData.City.toLowerCase().trim().replace(/\./g, "").replace(/\s+/g, "-");

let finalFaqs = premiumFaqs[cityKey] || {
    "tree-removal": [
      { q: `How much is tree removal in ${cityName}?`, a: `Costs vary based on tree size and proximity to ${landmark}. Call for a free estimate.` },
      { q: `Are you licensed in ${countyName} County?`, a: `Yes, we connect you with fully licensed and insured Florida crews.` },
    ],
    "stump-grinding": [
      { q: `Do you offer stump grinding in ${cityName}?`, a: `Yes, we provide full stump removal near ${landmark}.` },
      { q: `Will it prevent termites?`, a: `Absolutely. Removing stumps in ${countyName} County eliminates primary termite food sources.` },
    ],
    "emergency-service": [
      { q: `How fast is emergency response in ${cityName}?`, a: `Typically within 2-4 hours near ${landmark} after a storm.` },
      { q: `Do you work with insurance?`, a: `Yes, local crews help with insurance mitigation data in ${countyName} County.` },
    ],
  }[serviceInfo.prefix] || [];
---

<MainLayout title={`#1 ${serviceInfo.name} ${cityName}, FL | Licensed & Insured`} description={cityData.Description}>
  
  <!-- SEO: BREADCRUMB SCHEMA -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://protreetrim.com" },
      { "@type": "ListItem", "position": 2, "name": "Florida", "item": "https://protreetrim.com" },
      { "@type": "ListItem", "position": 3, "name": cityName, "item": currentUrl }
    ]
  })} />

  <!-- SEO: SERVICE SCHEMA -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Service",
    "serviceType": serviceInfo.name,
    "provider": { "@type": "LocalBusiness", "name": "ProTreeTrimâ„¢ Florida", "telephone": SITE_CONFIG.phone },
    "areaServed": [ { "@type": "City", "name": cityName }, { "@type": "AdministrativeArea", "name": countyName } ],
    "description": `Professional ${serviceInfo.name} services in ${cityName}, Florida. Licensed and insured experts.`
  })} />

  <header style="background: linear-gradient(135deg, #1b4332 0%, #081c15 100%); color: white; padding: 4.5rem 1.5rem; text-align: center; border-bottom: 5px solid #ea580c;">
    <div class="container">
      <div style="font-size: 0.85rem; margin-bottom: 1rem; color: #ffb703; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px;">Official Service Dispatch â€¢ {countyName} County</div>
      <h1 style="margin: 0; font-size: clamp(2rem, 7vw, 3.5rem); font-weight: 900; line-height: 1.1;">{cityName} {serviceInfo.name}</h1>
      <p style="font-size: 1.25rem; margin-top: 1.2rem; color: #95d5b2; max-width: 750px; margin-left: auto; margin-right: auto;">Providing elite care for properties near <strong>{landmark}</strong>.</p>
    </div>
  </header>

  <main class="container" style="max-width: 1100px; margin: -2.5rem auto 0; padding: 0 1rem; position: relative; z-index: 10;">
    
    <!-- â˜… DÃ–NÃœÅžÃœM MERKEZÄ°: TELEFON + HIZLI FORM â˜… -->
    <div class="cta-grid-container">
      <!-- SOL: TELEFON -->
      <div class="cta-call-box">
        <h3 style="margin: 0 0 10px; color: #064e3b; font-size: 1.4rem; font-weight: 800;">Call for Immediate Help</h3>
        <p style="color: #6b7280; margin-bottom: 1.5rem; font-size: 0.95rem;">Direct dispatch for {cityName} projects.</p>
        <a href={SITE_CONFIG.phoneHref} class="main-phone-btn">{SITE_CONFIG.phone}</a>
        <div style="margin-top: 15px; font-size: 0.8rem; font-weight: 700; color: #16a34a;">âš¡ AVERAGE RESPONSE: 2-4 HOURS</div>
      </div>

      <!-- SAÄž: HIZLI TEKLÄ°F FORMU -->
      <div class="cta-form-box">
        <h3 style="margin: 0 0 15px; color: #1b4332; font-size: 1.2rem; font-weight: 800;">Get a Quick Quote</h3>
        <form action="/api/contact" method="POST" class="mini-lead-form">
          <!-- Honeypot -->
          <div style="display:none;" aria-hidden="true"><input type="text" name="fax_number" tabindex="-1" autocomplete="off" /></div>
          
          <!-- Gizli Veriler (Lead takibi iÃ§in) -->
          <input type="hidden" name="city" value={cityName} />
          <input type="hidden" name="service" value={serviceInfo.name} />

          <div class="mini-form-row">
            <input type="text" name="name" placeholder="Name" required />
            <input type="tel" name="phone" placeholder="Phone" required />
          </div>
          <textarea name="message" rows="2" placeholder="Briefly describe the tree project..."></textarea>
          <button type="submit">SEND REQUEST</button>
        </form>
      </div>
    </div>

    <!-- LOCAL STATUS MONITOR -->
    <section style="margin-top: 3.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
      <div class="info-card-base monitor-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <div>
            <span style="background: #1b4332; color: #ffb703; font-size: 0.65rem; padding: 4px 12px; border-radius: 50px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.8px;">Local Authority Monitor</span>
            <h4 style="margin: 8px 0 0; color: #1e293b; font-size: 1.15rem; font-weight: 800;">{cityName} Service Status</h4>
          </div>
          <div style="text-align: right;">
            <div id="live-dot" class="active-pulse"></div>
            <span style="font-size: 0.75rem; font-weight: 900; color: #16a34a; text-transform: uppercase;">Active</span>
          </div>
        </div>
        <div style="background: #f8fafc; padding: 15px; border-radius: 18px; border: 1px solid #f1f5f9; margin: 10px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span id="current-date" style="font-size: 0.95rem; font-weight: 800; color: #1b4332;">--/--/2026</span>
            <span style="font-size: 1.3rem;">ðŸ“…</span>
          </div>
          <p style="margin: 0; font-size: 0.9rem; color: #4b5563; line-height: 1.5; font-weight: 700; font-style: italic;">{finalDynamicTip}</p>
        </div>
      </div>
      
      <!-- Local Service Hub -->
      <div class="info-card-base hub-card-style">
        <h4 style="margin: 0 0 15px; color: #166534; font-size: 1.15rem; font-weight: 800;">Local Service Hub</h4>
        <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
          {allServices.filter((s) => s.name !== serviceInfo.name).map((s) => (
            <a href={`/${s.prefix}-${cityKey}`} class="hub-link-item">
              <span>{s.icon}</span> {s.name} in {cityName} â†’
            </a>
          ))}
        </div>
      </div>
    </section>

    <!-- CONTENT AREA -->
    <section style="margin-top: 5rem;">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 40px; align-items: center;">
        <div>
          <h2 style="color: #064e3b; font-size: 1.8rem; font-weight: 900; margin-bottom: 1.5rem;">Expert {serviceInfo.name} in {cityName}</h2>
          <p style="font-size: 1.1rem; color: #374151; line-height: 1.8;">{cityData.Description}</p>
          <p style="font-size: 1.1rem; color: #374151; line-height: 1.8; margin-top: 1rem;">
            Beyond general maintenance, our specialists in <strong>{cityName}</strong> are specifically trained to manage the complex growth patterns of <strong>{cityData.MainTreeType}</strong>, ensuring structural integrity and long-term health. Located near <strong>{landmark}</strong>, we dispatch fully vetted crews that follow strict Florida safety standards for every <strong>{cityData.FocusService}</strong> project.
          </p>
        </div>
        {selectedImage && <Image src={selectedImage} alt={`${serviceInfo.name} in ${cityName}, FL - Certified crew near ${landmark}`} width={600} height={400} format="webp" style="width: 100%; height: auto; border-radius: 24px; box-shadow: 0 15px 30px rgba(0,0,0,0.08);" />}
      </div>
    </section>

    <!-- FAQ SECTION -->
    <section style="margin: 6rem 0;">
      <h2 style="color: #064e3b; font-size: 2rem; font-weight: 900; text-align: center; margin-bottom: 3rem;">Local FAQ for {cityName}</h2>
      <div style="display: grid; gap: 15px; max-width: 800px; margin: 0 auto;">
        {finalFaqs.map((f) => (
          <div style="background: white; padding: 1.5rem; border-radius: 20px; border: 1px solid #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.02);">
            <h4 style="color: #1b4332; font-weight: 800; margin: 0 0 10px; font-size: 1.15rem;">{f.q}</h4>
            <p style="color: #4b5563; line-height: 1.7; margin: 0; font-size: 1rem;">{f.a}</p>
          </div>
        ))}
      </div>
    </section>

    <!-- NEARBY FOOTPRINT -->
    <section style="margin-bottom: 12rem; border-top: 1px solid #eee; padding-top: 4rem; text-align: center;">
      <h3 style="color: #064e3b; font-size: 1rem; font-weight: 900; margin-bottom: 2rem; text-transform: uppercase; letter-spacing: 1px;">Also Serving Nearby {countyName} County Areas:</h3>
      <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;">
        {nearby.map((n: any) => (
          <a href={`/tree-removal-${n.City.toLowerCase().trim().replace(/\./g, "").replace(/\s+/g, "-")}`} class="nearby-tag">
            {toTitleCase(n.City)} Tree Service
          </a>
        ))}
      </div>
    </section>
  </main>

  <script is:inline>
    function runAuthorityMonitor() {
      const now = new Date();
      const dateEl = document.getElementById("current-date");
      if (dateEl) dateEl.innerText = now.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });
    }
    window.addEventListener("DOMContentLoaded", runAuthorityMonitor);
  </script>
</MainLayout>

<style>
  /* CTA GRID */
  .cta-grid-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    background: white;
    padding: 1.5rem;
    border-radius: 30px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
    border: 1px solid #eee;
  }
  
  .cta-call-box, .cta-form-box {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  
  .cta-call-box { border-right: 1px solid #f1f5f9; text-align: center; }

  .main-phone-btn {
    background: #ea580c;
    color: white !important;
    padding: 1.2rem;
    text-decoration: none;
    border-radius: 14px;
    font-weight: 900;
    font-size: clamp(1.4rem, 4vw, 2.2rem);
    box-shadow: 0 10px 25px rgba(234, 88, 12, 0.3);
    transition: 0.3s;
  }
  .main-phone-btn:hover { transform: translateY(-3px); background: #f97316; }

  /* MINI FORM */
  .mini-lead-form { display: grid; gap: 10px; }
  .mini-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .mini-lead-form input, .mini-lead-form textarea {
    width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; 
    font-size: 0.9rem; outline: none; background: #f8fafc; font-family: inherit;
  }
  .mini-lead-form input:focus { border-color: #1b4332; background: white; }
  .mini-lead-form button {
    background: #1b4332; color: white; border: none; padding: 12px; 
    border-radius: 10px; font-weight: 800; cursor: pointer; transition: 0.3s;
  }
  .mini-lead-form button:hover { background: #081c15; transform: translateY(-2px); }

  /* UTILS */
  .info-card-base { background: white; padding: 2.5rem; border-radius: 24px; border: 1px solid #eee; }
  .hub-link-item { color: #1b4332; text-decoration: none; font-size: 0.95rem; font-weight: 700; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
  .hub-link-item:hover { color: #ea580c; transform: translateX(5px); }
  .nearby-tag { background: white; color: #166534; padding: 10px 22px; border-radius: 50px; text-decoration: none; font-size: 0.9rem; font-weight: 700; border: 1px solid #e2e8f0; transition: 0.2s; }
  .nearby-tag:hover { background: #f0fdf4; border-color: #166534; transform: translateY(-2px); }

  @keyframes live-pulse { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 8px rgba(22, 163, 74, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); } }
  .active-pulse { animation: live-pulse 2s infinite; background: #16a34a; border-radius: 50%; width: 10px; height: 10px; display: inline-block; margin-right: 5px; }

  @media (max-width: 850px) {
    .cta-grid-container { grid-template-columns: 1fr; }
    .cta-call-box { border-right: none; border-bottom: 1px solid #f1f5f9; padding-bottom: 2rem; }
  }
</style>