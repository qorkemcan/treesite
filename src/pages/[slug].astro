---
import fs from "node:fs";
import path from "node:path";
import { parse } from "csv-parse/sync";
import MainLayout from "../layouts/MainLayout.astro";
import { SITE_CONFIG } from "../config.js";
import { Image } from "astro:assets";
import premiumFaqs from "../data/premium-faqs.json";
import arboristTips from "../data/arborist-tips.json";

export async function getStaticPaths() {
  const filePath = path.resolve("./src/data/cities.csv");
  const fileContent = fs.readFileSync(filePath, "utf-8");
  const records = parse(fileContent, {
    columns: true,
    skip_empty_lines: true,
    bom: true,
  });

  const services = [
    { prefix: "tree-removal", name: "Tree Removal", icon: "üå≥" },
    { prefix: "stump-grinding", name: "Stump Grinding", icon: "üèóÔ∏è" },
    { prefix: "emergency-service", name: "Emergency Tree Service", icon: "üå™Ô∏è" },
  ];

  const paths = [];
  records.forEach((row) => {
    if (!row.City) return;
    const citySlug = row.City.toLowerCase().trim().replace(/\./g, "").replace(/\s+/g, "-");
    
    services.forEach((service) => {
      paths.push({
        params: { slug: `${service.prefix}-${citySlug}` },
        props: {
          cityData: row,
          serviceInfo: service,
          allServices: services,
          nearby: records
            .filter((r) => r.County === row.County && r.City !== row.City)
            .slice(0, 5),
        },
      });
    });
  });
  return paths;
}

const { cityData, serviceInfo, nearby, allServices } = Astro.props;

const toTitleCase = (str) => {
  if (!str) return "";
  return str
    .toLowerCase()
    .split(" ")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
};

const cityName = toTitleCase(cityData.City);
const landmark = toTitleCase(cityData.Landmark) || "the local area";
const countyName = toTitleCase(cityData.County);
const currentUrl = new URL(Astro.url.pathname, SITE_CONFIG.siteUrl).toString();

const tipIndex = Math.abs((cityData.City + cityData.Landmark + serviceInfo.prefix).split('').reduce((a, b) => a + b.charCodeAt(0), 0)) % arboristTips.length;
const selectedTemplate = arboristTips[tipIndex];

const finalDynamicTip = selectedTemplate
  .replaceAll("[City]", cityName)
  .replaceAll("[Landmark]", landmark)
  .replaceAll("[MainTreeType]", cityData.MainTreeType || "local trees")
  .replaceAll("[FocusService]", cityData.FocusService || "professional tree care");

const serviceFolder = serviceInfo.prefix.includes("removal") ? "removal" : serviceInfo.prefix.includes("stump") ? "stump" : "emergency";
const allImages = import.meta.glob("../assets/gallery/fl/**/*.{jpeg,jpg,png,gif,webp}");
const imagePaths = Object.keys(allImages).filter((p) => p.includes(`/${serviceFolder}/`));

let selectedImage = null;
if (imagePaths.length > 0) {
  const imageIndex = Math.abs((cityName + serviceInfo.prefix).split("").reduce((a, b) => a + b.charCodeAt(0), 0)) % imagePaths.length;
  const imgModule: any = await allImages[imagePaths[imageIndex]]();
  selectedImage = imgModule.default;
}

// ‚òÖ AKILLI FAQ Sƒ∞STEMƒ∞ ‚òÖ
const cityKey = cityData.City.toLowerCase().trim().replace(/\./g, "").replace(/\s+/g, "-");

// Eƒüer premium-faqs.json dosyasƒ±nda yoksa, bu varsayƒ±lan ama dinamik listeyi kullan:
const defaultFaqs = [
  {
    q: `Do I need a permit for tree removal in ${cityName}?`,
    a: `Under Florida Statute 163.045, residential property owners in ${cityName} can generally remove hazardous trees without a local permit if a certified professional documents the danger. For non-hazardous trees near ${landmark}, we recommend checking with ${countyName} County's local ordinances.`
  },
  {
    q: `How much does ${serviceInfo.name} cost near ${landmark}?`,
    a: `Costs in ${cityName} depend on the tree's size, its proximity to structures near ${landmark}, and the specific equipment needed. We provide free, no-obligation estimates tailored to the unique conditions of your ${countyName} County property.`
  },
  {
    q: `Is your tree service licensed to work in ${countyName} County?`,
    a: `Yes, all crews in our network are fully licensed and insured to perform ${serviceInfo.name} and other arborist services throughout ${cityName} and the surrounding Florida areas.`
  },
  {
    q: `What is the best time of year for ${serviceInfo.name} in ${cityName}?`,
    a: `While Florida's climate allows for year-round care, January is an excellent time for dormant pruning of hardwoods. For properties near ${landmark}, scheduling maintenance before the peak of the hurricane season is the best way to prevent storm-related failures.`
  },
  {
    q: `Will homeowners insurance cover emergency tree work in ${cityName}?`,
    a: `Typically, insurance covers ${serviceInfo.name} if the tree has caused structural damage to your home or fence during a storm event. We provide the professional documentation and itemized invoices that ${countyName} County residents need to facilitate their claims.`
  }
];

let finalFaqs = premiumFaqs[cityKey] || defaultFaqs;

const faqSchema = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": finalFaqs.map(faq => ({
    "@type": "Question",
    "name": faq.q,
    "acceptedAnswer": { "@type": "Answer", "text": faq.a }
  }))
};
---

<MainLayout title={`#1 ${serviceInfo.name} ${cityName}, FL | Licensed & Insured`} description={cityData.Description}>
  
  <!-- SEO: SCHEMAS -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://protreetrim.com" },
      { "@type": "ListItem", "position": 2, "name": "Florida", "item": "https://protreetrim.com" },
      { "@type": "ListItem", "position": 3, "name": cityName, "item": currentUrl }
    ]
  })} />

  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Service",
    "serviceType": serviceInfo.name,
    "provider": { 
        "@type": "LocalBusiness", 
        "@id": `${SITE_CONFIG.siteUrl}/#localbusiness`,
        "name": "ProTreeTrim‚Ñ¢ Florida", 
        "telephone": SITE_CONFIG.phone 
    },
    "areaServed": [ { "@type": "City", "name": cityName }, { "@type": "AdministrativeArea", "name": countyName } ],
    "description": `Professional ${serviceInfo.name} services in ${cityName}, Florida. Licensed and insured experts.`
  })} />

  <!-- ‚òÖ SEO: FAQ SCHEMA ‚òÖ -->
  {finalFaqs.length > 0 && (
    <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />
  )}

  <header style="background: linear-gradient(135deg, #1b4332 0%, #081c15 100%); color: white; padding: 4.5rem 1.5rem; text-align: center; border-bottom: 5px solid #ea580c;">
    <div class="container">
      <div style="font-size: 0.85rem; margin-bottom: 1rem; color: #ffb703; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px;">Official Service Dispatch ‚Ä¢ {countyName} County</div>
      <h1 style="margin: 0; font-size: clamp(2rem, 7vw, 3.5rem); font-weight: 900; line-height: 1.1;">{cityName} {serviceInfo.name}</h1>
      <p style="font-size: 1.25rem; margin-top: 1.2rem; color: #95d5b2; max-width: 750px; margin-left: auto; margin-right: auto;">Providing elite care for properties near <strong>{landmark}</strong>.</p>
    </div>
  </header>

  <main class="container" style="max-width: 1100px; margin: -2.5rem auto 0; padding: 0 1rem; position: relative; z-index: 10;">
    
    <div class="cta-grid-container">
      <div class="cta-call-box">
        <h3 style="margin: 0 0 10px; color: #064e3b; font-size: 1.4rem; font-weight: 800;">Call for Immediate Help</h3>
        <p style="color: #6b7280; margin-bottom: 1.5rem; font-size: 0.95rem;">Direct dispatch for {cityName} projects.</p>
        <a href={SITE_CONFIG.phoneHref} class="main-phone-btn">{SITE_CONFIG.phone}</a>
        <div style="margin-top: 15px; font-size: 0.8rem; font-weight: 700; color: #16a34a;">‚ö° AVERAGE RESPONSE: 2-4 HOURS</div>
      </div>
      <div class="cta-form-box">
        <h3 style="margin: 0 0 15px; color: #1b4332; font-size: 1.2rem; font-weight: 800;">Get a Quick Quote</h3>
        <form action="/api/contact" method="POST" class="mini-lead-form">
          <div style="display:none;" aria-hidden="true"><input type="text" name="fax_number" tabindex="-1" autocomplete="off" /></div>
          <input type="hidden" name="city" value={cityName} /><input type="hidden" name="service" value={serviceInfo.name} />
          <div class="mini-form-row"><input type="text" name="name" placeholder="Name" required /><input type="tel" name="phone" placeholder="Phone" required /></div>
          <textarea name="message" rows="2" placeholder="Briefly describe the tree project..."></textarea>
          <button type="submit">SEND REQUEST</button>
        </form>
      </div>
    </div>

    <section style="margin-top: 4rem;">
      <h2 style="color: #064e3b; font-size: 1.8rem; font-weight: 900; text-align: center; margin-bottom: 2rem;">3 Simple Steps to Service</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
        <div class="info-card-base step-card"><div class="icon-box" style="background: #e0f2fe;">üìû</div><h4>1. Call Dispatch</h4><p>Connect with our {cityName} office instantly.</p></div>
        <div class="info-card-base step-card"><div class="icon-box" style="background: #fef3c7;">üìã</div><h4>2. Get a Quote</h4><p>A local specialist provides assessment and pricing.</p></div>
        <div class="info-card-base step-card"><div class="icon-box" style="background: #dcfce7;">‚úÖ</div><h4>3. Job Completed</h4><p>Safe execution and cleanup of your {cityName} property.</p></div>
      </div>
    </section>

    <section style="margin-top: 3.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
      <div class="info-card-base monitor-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <div><span style="background: #1b4332; color: #ffb703; font-size: 0.65rem; padding: 4px 12px; border-radius: 50px; font-weight: 800; text-transform: uppercase;">Local Authority Monitor</span><h4 style="margin: 8px 0 0; color: #1e293b; font-size: 1.15rem; font-weight: 800;">{cityName} Service Status</h4></div>
          <div style="text-align: right;"><div id="live-dot" class="active-pulse"></div><span style="font-size: 0.75rem; font-weight: 900; color: #16a34a;">Active</span></div>
        </div>
        <div style="background: #f8fafc; padding: 15px; border-radius: 18px; border: 1px solid #f1f5f9; margin: 10px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"><span id="current-date" style="font-size: 0.95rem; font-weight: 800; color: #1b4332;">--/--/2026</span><span style="font-size: 1.3rem;">üìÖ</span></div>
          <p style="margin: 0; font-size: 0.9rem; color: #4b5563; line-height: 1.5; font-weight: 700; font-style: italic;">{finalDynamicTip}</p>
        </div>
      </div>
      <div class="info-card-base hub-card-style">
        <h4 style="margin: 0 0 15px; color: #166534; font-size: 1.15rem; font-weight: 800;">Local Service Hub</h4>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          {allServices.filter((s) => s.name !== serviceInfo.name).map((s) => (
            <a href={`/${s.prefix}-${cityKey}`} class="hub-link-item"><span>{s.icon}</span> {s.name} in {cityName} ‚Üí</a>
          ))}
        </div>
      </div>
    </section>

    <section style="margin-top: 5rem;">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 40px; align-items: center;">
        <div>
          <h2 style="color: #064e3b; font-size: 1.8rem; font-weight: 900; margin-bottom: 1.5rem;">Expert {serviceInfo.name} in {cityName}</h2>
          <p style="font-size: 1.1rem; color: #374151; line-height: 1.8;">{cityData.Description}</p>
          <p style="font-size: 1.1rem; color: #374151; line-height: 1.8; margin-top: 1rem;">Beyond general maintenance, our specialists in <strong>{cityName}</strong> are trained to manage <strong>{cityData.MainTreeType}</strong> growth. Near <strong>{landmark}</strong>, we follow strict safety standards for every <strong>{cityData.FocusService}</strong> project.</p>
        </div>
        {selectedImage && <Image src={selectedImage} alt={`${serviceInfo.name} near ${landmark}`} width={600} height={400} format="webp" style="width: 100%; height: auto; border-radius: 24px; box-shadow: 0 15px 30px rgba(0,0,0,0.08);" />}
      </div>
    </section>

    <section style="margin-top: 6rem;">
      <h2 style="color: #064e3b; font-size: 2rem; font-weight: 900; text-align: center; margin-bottom: 2.5rem;">Why Choose Our {cityName} Network?</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px;">
        <div class="info-card-base feature-card"><div class="icon-box" style="background: #dcfce7;">üõ°Ô∏è</div><h4>Verified Compliance</h4><p>Licensed and insured according to Florida's standards for {cityName}.</p></div>
        <div class="info-card-base feature-card"><div class="icon-box" style="background: #fef3c7;">üöú</div><h4>Elite Equipment</h4><p>Advanced machinery to handle Live Oaks and Slash Pines safely.</p></div>
        <div class="info-card-base feature-card"><div class="icon-box" style="background: #fee2e2;">üöë</div><h4>Storm Response</h4><p>Emergency fallen tree removal across {countyName} County.</p></div>
      </div>
    </section>

    <!-- ‚òÖ FAQ SECTION (Dƒ∞NAMƒ∞K YEDEKLEMELƒ∞) ‚òÖ -->
    <section style="margin: 6rem 0;">
      <h2 style="color: #064e3b; font-size: 2rem; font-weight: 900; text-align: center; margin-bottom: 3rem;">Local FAQ for {cityName}</h2>
      <div style="display: grid; gap: 15px; max-width: 800px; margin: 0 auto;">
        {finalFaqs.map((f) => (
          <div style="background: white; padding: 1.5rem; border-radius: 20px; border: 1px solid #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.02);">
            <h4 style="color: #1b4332; font-weight: 800; margin: 0 0 10px;">{f.q}</h4>
            <p style="color: #4b5563; line-height: 1.7;">{f.a}</p>
          </div>
        ))}
      </div>
    </section>

    <section style="margin-bottom: 12rem; border-top: 1px solid #eee; padding-top: 4rem; text-align: center;">
      <h3 style="color: #064e3b; font-size: 1rem; font-weight: 900; margin-bottom: 2rem; text-transform: uppercase;">Also Serving Nearby {countyName} County Areas:</h3>
      <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;">
        {nearby.map((n: any) => ( <a href={`/tree-removal-${n.City.toLowerCase().trim().replace(/\./g, "").replace(/\s+/g, "-")}`} class="nearby-tag">{toTitleCase(n.City)} Tree Service</a> ))}
      </div>
    </section>
  </main>

  <script is:inline>
    function runAuthorityMonitor() {
      const now = new Date();
      const dateEl = document.getElementById("current-date");
      if (dateEl) dateEl.innerText = now.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });
    }
    window.addEventListener("DOMContentLoaded", runAuthorityMonitor);
  </script>
</MainLayout>

<style>
  .info-card-base { background: white; padding: 2.5rem; border-radius: 24px; border: 1px solid #eee; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.03); }
  .cta-grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: white; padding: 1.5rem; border-radius: 30px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); border: 1px solid #eee; }
  .cta-call-box, .cta-form-box { padding: 1.5rem; display: flex; flex-direction: column; justify-content: center; }
  .cta-call-box { border-right: 1px solid #f1f5f9; text-align: center; }
  .main-phone-btn { background: #ea580c; color: white !important; padding: 1.2rem; text-decoration: none; border-radius: 14px; font-weight: 900; font-size: clamp(1.4rem, 4vw, 2.2rem); box-shadow: 0 10px 25px rgba(234, 88, 12, 0.3); transition: 0.3s; }
  .main-phone-btn:hover { transform: translateY(-3px); background: #f97316; }
  .mini-lead-form { display: grid; gap: 10px; }
  .mini-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .mini-lead-form input, .mini-lead-form textarea { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; font-size: 0.9rem; outline: none; background: #f8fafc; font-family: inherit; }
  .mini-lead-form button { background: #1b4332; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 800; cursor: pointer; transition: 0.3s; }
  .step-card { text-align: center; }
  .feature-card { text-align: left; transition: transform 0.3s ease; }
  .icon-box { width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; margin-bottom: 1.5rem; }
  .step-card .icon-box { margin-left: auto; margin-right: auto; }
  h4 { font-weight: 900; color: #1b4332; margin: 0 0 12px; }
  .hub-link-item { color: #1b4332; text-decoration: none; font-size: 0.95rem; font-weight: 700; display: flex; align-items: center; gap: 10px; transition: 0.2s; margin-bottom: 5px; }
  .hub-link-item:hover { color: #ea580c; transform: translateX(5px); }
  .nearby-tag { background: white; color: #166534; padding: 10px 22px; border-radius: 50px; text-decoration: none; font-size: 0.9rem; font-weight: 700; border: 1px solid #e2e8f0; transition: 0.2s; }
  .nearby-tag:hover { background: #f0fdf4; border-color: #166534; transform: translateY(-2px); }
  @keyframes live-pulse { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 8px rgba(22, 163, 74, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); } }
  .active-pulse { animation: live-pulse 2s infinite; background: #16a34a; border-radius: 50%; width: 10px; height: 10px; display: inline-block; margin-right: 5px; }
  @media (max-width: 850px) { .cta-grid-container { grid-template-columns: 1fr; } .cta-call-box { border-right: none; border-bottom: 1px solid #f1f5f9; padding-bottom: 2rem; } }
</style>