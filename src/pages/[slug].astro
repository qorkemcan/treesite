---
import fs from "node:fs";
import path from "node:path";
import { parse } from "csv-parse/sync";
import MainLayout from "../layouts/MainLayout.astro";
import { SITE_CONFIG } from "../config.js";
import { Image } from "astro:assets";

export async function getStaticPaths() {
  const filePath = path.resolve("./src/data/cities.csv");
  const fileContent = fs.readFileSync(filePath, "utf-8");
  const records = parse(fileContent, {
    columns: true,
    skip_empty_lines: true,
    bom: true,
  });

  const services = [
    { prefix: "tree-removal", name: "Tree Removal", icon: "üå≥" },
    { prefix: "stump-grinding", name: "Stump Grinding", icon: "üèóÔ∏è" },
    { prefix: "emergency-service", name: "Emergency Tree Service", icon: "üå™Ô∏è" },
  ];

  const paths = [];
  records.forEach((row) => {
    if (!row.City) return;
    const citySlug = row.City.toLowerCase().trim().replace(/\s+/g, "-");
    services.forEach((service) => {
      paths.push({
        params: { slug: `${service.prefix}-${citySlug}` },
        props: {
          cityData: row,
          serviceInfo: service,
          nearby: records
            .filter((r) => r.County === row.County && r.City !== row.City)
            .slice(0, 5),
        },
      });
    });
  });
  return paths;
}

const { cityData, serviceInfo, nearby } = Astro.props;

const toTitleCase = (str) => {
  if (!str) return "";
  return str
    .toLowerCase()
    .split(" ")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
};

const cityName = toTitleCase(cityData.City);
const landmark = toTitleCase(cityData.Landmark) || "The Local Area";
const countyName = toTitleCase(cityData.County);

const serviceFolder = serviceInfo.prefix.includes("removal")
  ? "removal"
  : serviceInfo.prefix.includes("stump")
    ? "stump"
    : "emergency";

const allImages = import.meta.glob(
  "../assets/gallery/fl/**/*.{jpeg,jpg,png,gif,webp}",
);
const imagePaths = Object.keys(allImages).filter((path) =>
  path.includes(`/${serviceFolder}/`),
);

let selectedImage = null;
if (imagePaths.length > 0) {
  const imageIndex =
    Math.abs(
      (cityName + serviceInfo.prefix)
        .split("")
        .reduce((acc, char) => acc + char.charCodeAt(0), 0),
    ) % imagePaths.length;
  const selectedImageImport = allImages[imagePaths[imageIndex]];
  const imgModule: any = await selectedImageImport();
  selectedImage = imgModule.default;
}

const faqs =
  {
    "tree-removal": [
      {
        q: `How much does tree removal cost in ${cityName}?`,
        a: `Tree removal in ${cityName} is priced based on tree size and proximity to structures like ${landmark}. We provide free on-site estimates.`,
      },
      {
        q: `Are you licensed for hazardous removals in ${countyName} County?`,
        a: `Yes, our network connects you with fully licensed and insured crews specialized in dangerous Florida tree removals.`,
      },
    ],
    "stump-grinding": [
      {
        q: `Do you offer stump grinding in ${cityName}?`,
        a: `Yes, we provide full stump removal and surface root grinding to restore your property near ${landmark}.`,
      },
      {
        q: `Will stump removal prevent termites?`,
        a: `Absolutely. Grinding down stumps in ${countyName} County removes the primary food source for subterranean termites.`,
      },
    ],
    "emergency-service": [
      {
        q: `How fast is emergency tree response near ${landmark}?`,
        a: `Our 24/7 dispatch network typically reaches ${cityName} homes within 2-4 hours after a major storm.`,
      },
      {
        q: `Do you work with insurance in ${cityName}?`,
        a: `Yes, our local crews provide photos and data needed for storm damage insurance mitigation in ${countyName} County.`,
      },
    ],
  }[serviceInfo.prefix] || [];

const optimizedTitle = `#1 ${serviceInfo.name} in ${cityName}, FL | Licensed & Insured`;
---

<MainLayout title={optimizedTitle} description={cityData.Description}>
  <header
    style="background: linear-gradient(135deg, #1b4332 0%, #081c15 100%); color: white; padding: 4rem 1.5rem; text-align: center; border-bottom: 5px solid #ea580c;"
  >
    <div class="container">
      <div
        style="font-size: 0.85rem; margin-bottom: 1rem; color: #ffb703; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px;"
      >
        Verified Experts in {countyName} County
      </div>
      <h1
        style="margin: 0; font-size: clamp(1.8rem, 7vw, 3rem); font-weight: 900; line-height: 1.2;"
      >
        {cityName}
        {serviceInfo.name}
      </h1>
      <p
        style="font-size: 1.2rem; margin-top: 1rem; color: #95d5b2; max-width: 750px; margin-left: auto; margin-right: auto;"
      >
        Serving the {cityName} community near <strong>{landmark}</strong>.
      </p>
    </div>
  </header>

  <main
    class="container"
    style="max-width: 1000px; margin: -2.5rem auto 0; padding: 0 1rem; position: relative; z-index: 10;"
  >
    <!-- CTA BOX -->
    <div
      style="background: white; padding: 2.5rem 1.5rem; border-radius: 20px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.1); border: 1px solid #eee;"
    >
      <h3
        style="margin: 0 0 10px; color: #064e3b; font-size: 1.6rem; font-weight: 800;"
      >
        Get a Free Estimate
      </h3>
      <p style="color: #6b7280; margin-bottom: 1.5rem; font-size: 0.95rem;">
        Licensed & insured professionals in {cityName}.
      </p>
      <a
        href={SITE_CONFIG.phoneHref}
        style="background: #ea580c; color: white !important; padding: 1.2rem; text-decoration: none; border-radius: 12px; font-weight: 900; font-size: clamp(1.3rem, 5vw, 1.8rem); display: block; box-shadow: 0 8px 20px rgba(234, 88, 12, 0.3);"
        >{SITE_CONFIG.phone}</a
      >
    </div>

    <!-- HOW IT WORKS (RE-STYLED) -->
    <section style="margin-top: 4rem;">
      <h2
        style="color: #064e3b; font-size: 1.8rem; font-weight: 900; text-align: center; margin-bottom: 2rem;"
      >
        3 Simple Steps to Service
      </h2>
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;"
      >
        <div
          style="background: white; padding: 2rem; border-radius: 20px; border: 1px solid #eee; text-align: center; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);"
        >
          <div
            style="background: #e0f2fe; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 0 auto 1.5rem;"
          >
            üìû
          </div>
          <h4 style="font-weight: 800; margin-bottom: 10px; color: #1b4332;">
            1. Call Us
          </h4>
          <p style="font-size: 0.9rem; color: #4b5563; line-height: 1.5;">
            Connect with our dispatch office instantly for help.
          </p>
        </div>
        <div
          style="background: white; padding: 2rem; border-radius: 20px; border: 1px solid #eee; text-align: center; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);"
        >
          <div
            style="background: #fef3c7; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 0 auto 1.5rem;"
          >
            üìã
          </div>
          <h4 style="font-weight: 800; margin-bottom: 10px; color: #1b4332;">
            2. Free Quote
          </h4>
          <p style="font-size: 0.9rem; color: #4b5563; line-height: 1.5;">
            Get an expert assessment and no-obligation pricing.
          </p>
        </div>
        <div
          style="background: white; padding: 2rem; border-radius: 20px; border: 1px solid #eee; text-align: center; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);"
        >
          <div
            style="background: #dcfce7; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 0 auto 1.5rem;"
          >
            ‚úÖ
          </div>
          <h4 style="font-weight: 800; margin-bottom: 10px; color: #1b4332;">
            3. Job Done
          </h4>
          <p style="font-size: 0.9rem; color: #4b5563; line-height: 1.5;">
            Professional service completed with full property cleanup.
          </p>
        </div>
      </div>
    </section>

    <!-- CONTENT AND IMAGE -->
    <section style="margin-top: 4rem;">
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; align-items: center;"
      >
        <div>
          <h2
            style="color: #064e3b; font-size: 1.6rem; font-weight: 800; margin-bottom: 1rem;"
          >
            Expert {serviceInfo.name} in {cityName}
          </h2>
          <p
            style="font-size: 1rem; color: #374151; line-height: 1.6; margin-bottom: 1rem;"
          >
            {cityData.Description}
          </p>
          <p style="font-size: 0.95rem; color: #4b5563; line-height: 1.6;">
            Our network of tree care professionals prioritizes safety and
            property protection. We understand the unique needs of Florida
            landscapes.
          </p>
        </div>
        {
          selectedImage && (
            <Image
              src={selectedImage}
              alt={`${serviceInfo.name} in ${cityName}`}
              width={600}
              height={400}
              format="webp"
              style="width: 100%; height: auto; border-radius: 16px; box-shadow: 0 10px 20px rgba(0,0,0,0.05);"
            />
          )
        }
      </div>
    </section>

    <!-- WHY CHOOSE US (MOVED NEAR FAQ) -->
    <section style="margin-top: 5rem;">
      <h2
        style="color: #064e3b; font-size: 1.8rem; font-weight: 900; text-align: center; margin-bottom: 2rem;"
      >
        Why Choose Our {cityName} Network?
      </h2>
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;"
      >
        <div
          style="background: white; padding: 2rem; border-radius: 20px; border: 1px solid #eee; text-align: left; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);"
        >
          <div
            style="background: #dcfce7; width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 1rem;"
          >
            üõ°Ô∏è
          </div>
          <h4 style="margin-bottom: 8px; font-weight: 800; color: #1b4332;">
            Verified Compliance
          </h4>
          <p style="font-size: 0.85rem; color: #4b5563; line-height: 1.5;">
            Licensed and insured crews specialized in {cityName} tree care standards.
          </p>
        </div>
        <div
          style="background: white; padding: 2rem; border-radius: 20px; border: 1px solid #eee; text-align: left; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);"
        >
          <div
            style="background: #fef3c7; width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 1rem;"
          >
            üöú
          </div>
          <h4 style="margin-bottom: 8px; font-weight: 800; color: #1b4332;">
            Expert Equipment
          </h4>
          <p style="font-size: 0.85rem; color: #4b5563; line-height: 1.5;">
            From massive Oaks near {landmark} to Palms, we have the right tools for
            the job.
          </p>
        </div>
        <div
          style="background: white; padding: 2rem; border-radius: 20px; border: 1px solid #eee; text-align: left; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);"
        >
          <div
            style="background: #fee2e2; width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 1rem;"
          >
            üöë
          </div>
          <h4 style="margin-bottom: 8px; font-weight: 800; color: #1b4332;">
            Storm Ready
          </h4>
          <p style="font-size: 0.85rem; color: #4b5563; line-height: 1.5;">
            Priority dispatch for emergency storm damage in {countyName} County.
          </p>
        </div>
      </div>
    </section>

    <!-- FAQ -->
    <section style="margin-top: 4rem;">
      <h2
        style="color: #064e3b; font-size: 1.8rem; font-weight: 900; text-align: center; margin-bottom: 2rem;"
      >
        Common Questions
      </h2>
      <div style="display: flex; flex-direction: column; gap: 15px;">
        {
          faqs.map((f) => (
            <div style="background: white; padding: 1.5rem; border-radius: 16px; border: 1px solid #eee;">
              <h4 style="color: #1b4332; font-weight: 800; margin: 0 0 10px; font-size: 1.1rem;">
                {f.q}
              </h4>
              <p style="color: #4b5563; line-height: 1.6; margin: 0; font-size: 0.95rem;">
                {f.a}
              </p>
            </div>
          ))
        }
      </div>
    </section>

    <!-- NEARBY CITIES -->
    <section
      style="margin-top: 4rem; margin-bottom: 8rem; border-top: 1px solid #eee; padding-top: 3rem;"
    >
      <h3
        style="color: #064e3b; font-size: 1.1rem; font-weight: 800; margin-bottom: 1.5rem; text-align: center;"
      >
        Other Service Areas in {countyName} County:
      </h3>
      <div
        style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;"
      >
        {
          nearby.map((n: any) => (
            <a
              href={`/tree-removal-${n.City.toLowerCase().replace(/\s+/g, "-")}`}
              style="background: white; color: #166534; padding: 8px 16px; border-radius: 50px; text-decoration: none; font-size: 0.85rem; font-weight: 700; border: 1px solid #dcfce7; transition: 0.2s;"
              class="nearby-link"
            >
              {toTitleCase(n.City)} Tree Service
            </a>
          ))
        }
      </div>
    </section>
  </main>
</MainLayout>

<style>
  .nearby-link:hover {
    background: #f0fdf4 !important;
    border-color: #166534 !important;
    transform: translateY(-2px);
  }
</style>
