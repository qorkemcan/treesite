---
import fs from "node:fs";
import path from "node:path";
import { parse } from "csv-parse/sync";
import MainLayout from "../layouts/MainLayout.astro";
import { SITE_CONFIG } from "../config.js";
import PriceCalculator from "../components/PriceCalculator.astro";

const filePath = path.resolve("./src/data/cities.csv");
const fileContent = fs.readFileSync(filePath, "utf-8");
const records = parse(fileContent, {
  columns: true,
  skip_empty_lines: true,
  bom: true,
});

// SEO ƒ∞√áƒ∞N G√úNCEL TARƒ∞H
const currentYear = new Date().getFullYear();
const currentMonth = new Date().toLocaleString('en-US', { month: 'long' });

// M√ºkerrerleri temizle ve ƒ∞l√ßelere (County) g√∂re grupla
const seenCities = new Set();
const groupedCities = records.reduce((acc: any, city: any) => {
  const cityName = city.City.trim();
  const lowerCity = cityName.toLowerCase();

  if (!seenCities.has(lowerCity)) {
    seenCities.add(lowerCity);
    const county = city.County || "Florida Areas";
    if (!acc[county]) acc[county] = [];
    acc[county].push(city);
  }
  return acc;
}, {});

const counties = Object.keys(groupedCities).sort();

const toTitleCase = (str) => {
  if (!str) return "";
  return str
    .toLowerCase()
    .split(" ")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
};

// POP√úLER ≈ûEHƒ∞RLER Lƒ∞STESƒ∞ (KORUNDU)
const featuredCities = [
  { name: "Miami", slug: "miami", icon: "üèôÔ∏è", desc: "Dade County" },
  { name: "Orlando", slug: "orlando", icon: "üé¢", desc: "Orange County" },
  { name: "Tampa", slug: "tampa", icon: "‚öì", desc: "Hillsborough" },
  { name: "Jacksonville", slug: "jacksonville", icon: "üåâ", desc: "Duval County" },
  { name: "Fort Lauderdale", slug: "fort-lauderdale", icon: "üõ•Ô∏è", desc: "Broward County" },
  { name: "Tallahassee", slug: "tallahassee", icon: "üèõÔ∏è", desc: "Leon County" },
  { name: "Cape Coral", slug: "cape-coral", icon: "üèñÔ∏è", desc: "Lee County" },
  { name: "St. Petersburg", slug: "st-petersburg", icon: "‚òÄÔ∏è", desc: "Pinellas County" },
];
---

<MainLayout
  title={`Florida Tree Service Network | Licensed Arborists ${currentYear}`}
  description={`Official 2026 tree service directory for Florida. Find certified experts for tree removal, stump grinding, and emergency dispatch across all 67 counties.`}
>
  <!-- HERO SECTION (G√úNCELLENDƒ∞: Freshness eklendi) -->
  <header
    style="background: linear-gradient(135deg, #1b4332 0%, #081c15 100%); color: white; padding: 6rem 1.5rem; text-align: center; border-bottom: 6px solid #ea580c;"
  >
    <div class="container">
      <div style="background: rgba(234, 88, 12, 0.2); display: inline-block; padding: 5px 15px; border-radius: 50px; margin-bottom: 1rem; border: 1px solid #ea580c;">
          <span style="color: #ffb703; font-weight: 800; font-size: 0.8rem; text-transform: uppercase;">Updated: {currentMonth} {currentYear}</span>
      </div>
      <h1
        style="font-size: clamp(2.5rem, 8vw, 4.5rem); margin: 0; letter-spacing: -2px; font-weight: 900; line-height: 0.95;"
      >
        FLORIDA TREE <br /><span style="color: #ffb703;">SERVICE NETWORK</span>
      </h1>
      <p
        style="font-size: 1.25rem; color: #95d5b2; margin-top: 2rem; max-width: 800px; margin-left: auto; margin-right: auto; font-weight: 500;"
      >
        Florida's most comprehensive directory for verified tree care experts and immediate emergency removal services.
      </p>

      <!-- LIVE SEARCH BOX -->
      <div
        style="margin-top: 3.5rem; max-width: 650px; margin-left: auto; margin-right: auto; background: white; padding: 6px; border-radius: 50px; display: flex; align-items: center; box-shadow: 0 15px 35px rgba(0,0,0,0.4); border: 2px solid #ea580c;"
      >
        <div style="padding-left: 20px; font-size: 1.4rem;">üîç</div>
        <input
          type="text"
          id="citySearch"
          placeholder="Type your city (e.g. Miami, Tampa...)"
          style="width: 100%; border: none; padding: 15px 12px; font-size: 1.15rem; border-radius: 50px; outline: none; color: #1b4332; font-weight: 600;"
        />
      </div>
    </div>
  </header>

  <div class="container">
    <!-- STATS SECTION -->
    <section
      style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; margin-top: -3rem; position: relative; z-index: 20;"
    >
      <div class="stat-card">
        üå™Ô∏è <h3>Emergency</h3><p>24/7 storm response dispatch across Florida.</p>
      </div>
      <div class="stat-card">
        üõ°Ô∏è <h3>Vetted Pros</h3><p>Only licensed and insured local specialists.</p>
      </div>
      <div class="stat-card">
        üèóÔ∏è <h3>Statewide</h3><p>Kapsayƒ±cƒ± removal, grinding & pruning.</p>
      </div>
    </section>

    <!-- PRICE CALCULATOR -->
    <div style="margin-top: 4rem;">
      <PriceCalculator />
    </div>

    <!-- MAJOR HUB CARDS -->
    <section style="margin-top: 6rem;">
      <h2
        style="text-align: center; color: #064e3b; font-size: 2.2rem; margin-bottom: 0.5rem; font-weight: 900;"
      >
        Major Service Hubs
      </h2>
      <p style="text-align: center; color: #64748b; margin-bottom: 3rem;">
        Instant access to Florida's high-demand service areas.
      </p>
      <div class="hub-grid">
        {
          featuredCities.map((city) => (
            <a href={`/tree-removal-${city.slug}`} class="hub-card">
              <span class="hub-icon">{city.icon}</span>
              <div class="hub-info">
                <h4>{city.name}</h4>
                <span>{city.desc}</span>
              </div>
              <span class="hub-arrow">‚Üí</span>
            </a>
          ))
        }
      </div>
    </section>

    <!-- DIRECTORY SECTION (G√úNCELLEME: COUNTY Lƒ∞NKLERƒ∞ EKLENDƒ∞) -->
    <section id="directory" style="margin-top: 8rem; margin-bottom: 12rem;">
      <div style="border-top: 2px solid #f1f5f9; padding-top: 4rem;">
        <h2
          style="text-align: center; color: #064e3b; font-size: 2rem; margin-bottom: 3rem; font-weight: 900;"
        >
          Browse Local Dispatch by County
        </h2>

        <div id="countyGrid" class="directory-grid">
          {
            counties.map((county) => {
              const countySlug = county.toLowerCase().trim().replace(/\s+/g, "-");
              return (
                <div class="county-card" data-county={county.toLowerCase()}>
                  <!-- TOGGLE BUTTON -->
                  <div style="display: flex; align-items: center; background: white;">
                    <button class="county-toggle" aria-expanded="false" style="flex: 1;">
                      <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1rem;">üå¥</span>
                        <span class="county-name">{toTitleCase(county)}</span>
                      </div>
                      <span class="chevron">‚ñº</span>
                    </button>
                    <!-- YENƒ∞: Doƒürudan ƒ∞l√ße Hub Sayfasƒ±na Giden Link -->
                    <a href={`/county/${countySlug}`} title={`View all cities in ${county}`} style="padding: 1rem; text-decoration: none; font-size: 0.8rem; font-weight: 800; color: #ea580c; border-left: 1px solid #f1f5f9;">HUB ‚Üí</a>
                  </div>

                  <div class="city-list-content">
                    <div style="display: grid; grid-template-columns: 1fr; gap: 15px; padding: 1.5rem; border-top: 1px solid #f1f5f9;">
                      {groupedCities[county].map((city: any) => {
                        const citySlug = city.City.toLowerCase()
                          .trim()
                          .replace(/\./g, "")
                          .replace(/\s+/g, "-");
                        return (
                          <div
                            class="city-item"
                            data-city={city.City.toLowerCase()}
                          >
                            <a
                              href={`/tree-removal-${citySlug}`}
                              class="main-service-link"
                            >
                              {toTitleCase(city.City)} Tree Service
                            </a>
                            <div class="sub-services">
                              <a href={`/stump-grinding-${citySlug}`}>üèóÔ∏è Stump Grinding</a>
                              <a href={`/emergency-service-${citySlug}`}>‚ö° Emergency</a>
                            </div>
                          </div>
                        );
                      })}
                      <!-- ƒ∞L√áE HUB'INA ALT Lƒ∞NK (Link g√ºc√ºn√º peki≈ütirmek i√ßin) -->
                      <a href={`/county/${countySlug}`} style="text-align: center; padding-top: 10px; font-weight: 800; color: #16a34a; text-decoration: none; font-size: 0.85rem; border-top: 1px dashed #eee;">View Full {toTitleCase(county)} Directory ‚Üí</a>
                    </div>
                  </div>
                </div>
              )
            })
          }
        </div>
      </div>
    </section>

    <!-- LEGAL AUTHORITY SECTION (YENƒ∞ - EEAT PUANI ƒ∞√áƒ∞N) -->
    <section style="margin-bottom: 10rem; background: #f8fafc; padding: 4rem 2rem; border-radius: 40px; border: 1px solid #e2e8f0; text-align: center;">
        <h2 style="color: #1b4332; font-weight: 900; font-size: 1.8rem; margin-bottom: 1.5rem;">Florida Statute 163.045: Your Right to Safety</h2>
        <p style="max-width: 900px; margin: 0 auto; color: #475569; line-height: 1.8; font-size: 1.1rem; font-weight: 500;">
            Did you know that Florida state law protects a residential property owner's right to remove a high-risk tree without a local permit? 
            In <strong>{currentYear}</strong>, we continue to help homeowners navigate these regulations by providing the professional arborist 
            documentation required under state law to clear hazards instantly. Whether you are in <strong>Miami-Dade</strong>, 
            <strong>Orange</strong>, or <strong>Duval County</strong>, our network ensures compliance and safety.
        </p>
        <div style="margin-top: 2.5rem;">
            <a href="/trust-safety" style="background: #1b4332; color: white; padding: 15px 30px; border-radius: 12px; text-decoration: none; font-weight: 800;">Learn More About Safety Standards</a>
        </div>
    </section>
  </div>
</MainLayout>

<style>
  /* Mevcut stiller korundu, eklemeler yapƒ±ldƒ± */
  .stat-card {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    text-align: center;
  }
  .stat-card h3 { color: #064e3b; margin: 10px 0 0; font-weight: 900; }
  .stat-card p { color: #64748b; font-size: 0.85rem; margin-top: 5px; }

  .hub-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.5rem; }
  .hub-card {
    background: white; padding: 1.5rem; border-radius: 16px; border: 1px solid #e5e7eb;
    display: flex; align-items: center; gap: 15px; text-decoration: none; transition: all 0.3s ease;
  }
  .hub-card:hover { transform: translateY(-5px); border-color: #ea580c; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
  .hub-icon { font-size: 2rem; }
  .hub-info h4 { margin: 0; color: #1b4332; font-weight: 800; }
  .hub-info span { font-size: 0.75rem; color: #64748b; font-weight: 600; }
  .hub-arrow { margin-left: auto; color: #cbd5e1; font-weight: 900; }

  .directory-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
  @media (max-width: 1024px) { .directory-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 768px) { .directory-grid { grid-template-columns: 1fr; } }

  .county-card { background: white; border-radius: 12px; border: 1px solid #e5e7eb; overflow: hidden; height: fit-content; }
  .county-toggle {
    padding: 1rem; background: none; border: none; display: flex; justify-content: space-between;
    align-items: center; cursor: pointer; text-align: left;
  }
  .county-name { color: #1b4332; font-weight: 800; font-size: 0.95rem; }
  .chevron { font-size: 0.7rem; color: #94a3b8; transition: transform 0.3s; }

  .city-list-content { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0, 1, 0, 1); background: #fff; }
  .county-card.is-open .city-list-content { max-height: 5000px; transition: max-height 0.4s ease-in-out; }
  .county-card.is-open .chevron { transform: rotate(180deg); color: #ea580c; }
  .county-card.is-open { border-color: #ea580c; }

  .city-item { display: flex; flex-direction: column; gap: 4px; border-bottom: 1px solid #f8fafc; padding-bottom: 10px; }
  .main-service-link { text-decoration: none; color: #1b4332; font-weight: 800; font-size: 0.9rem; }
  .sub-services { display: flex; gap: 10px; }
  .sub-services a { text-decoration: none; color: #64748b; font-size: 0.65rem; font-weight: 700; }
  .sub-services a:hover { color: #ea580c; }
</style>

<script is:inline>
  const searchInput = document.getElementById("citySearch");
  const countyCards = document.querySelectorAll(".county-card");

  countyCards.forEach((card) => {
    const btn = card.querySelector(".county-toggle");
    btn.addEventListener("click", () => {
      const isOpen = card.classList.contains("is-open");
      card.classList.toggle("is-open", !isOpen);
    });
  });

  searchInput.addEventListener("input", (e) => {
    const term = e.target.value.toLowerCase().trim();
    countyCards.forEach((card) => {
      const countyName = card.getAttribute("data-county");
      const cityItems = card.querySelectorAll(".city-item");
      let hasVisibleCity = false;

      if (term.length === 0) {
        card.style.display = "block";
        card.classList.remove("is-open");
        cityItems.forEach((i) => (i.style.display = "flex"));
        return;
      }

      cityItems.forEach((item) => {
        const cityName = item.getAttribute("data-city");
        if (cityName.includes(term) || countyName.includes(term)) {
          item.style.display = "flex";
          hasVisibleCity = true;
        } else {
          item.style.display = "none";
        }
      });

      if (hasVisibleCity || countyName.includes(term)) {
        card.style.display = "block";
        card.classList.add("is-open");
      } else {
        card.style.display = "none";
        card.classList.remove("is-open");
      }
    });
  });
</script>