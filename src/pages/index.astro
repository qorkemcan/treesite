---
import fs from 'node:fs';
import path from 'node:path';
import { parse } from 'csv-parse/sync';
import MainLayout from '../layouts/MainLayout.astro';
import { SITE_CONFIG } from '../config.js';

const filePath = path.resolve('./src/data/cities.csv');
const fileContent = fs.readFileSync(filePath, 'utf-8');
const records = parse(fileContent, { columns: true, skip_empty_lines: true, bom: true });

// M√ºkerrerleri temizle ve ƒ∞l√ßelere g√∂re grupla
const seenCities = new Set();
const groupedCities = records.reduce((acc: any, city: any) => {
  const cityName = city.City.toLowerCase().trim();
  if (!seenCities.has(cityName)) {
    seenCities.add(cityName);
    const county = city.County || 'Florida Areas';
    if (!acc[county]) acc[county] = [];
    acc[county].push(city);
  }
  return acc;
}, {});

const counties = Object.keys(groupedCities).sort();
---

<MainLayout 
  title="Florida's Premier Tree Care Service Network" 
  description="The 2026 Directory for Florida Tree Removal. Connecting you with certified, licensed professionals across all 67 counties for storm prep and trimming."
>
  <header style="background: linear-gradient(135deg, #1b4332 0%, #081c15 100%); color: white; padding: 6rem 1.5rem; text-align: center; border-bottom: 6px solid #ea580c;">
    <h1 style="font-size: clamp(2.5rem, 8vw, 4.5rem); margin: 0; letter-spacing: -2px; font-weight: 900; line-height: 0.95;">FLORIDA TREE <br/><span style="color: #ffb703;">SERVICE NETWORK</span></h1>
    <p style="font-size: 1.4rem; color: #95d5b2; margin-top: 2rem; max-width: 800px; margin-left: auto; margin-right: auto; font-weight: 400;">The Official 2026 Directory for Certified Arborists & Emergency Response across the Sunshine State.</p>
    
    <div style="margin-top: 3rem; max-width: 600px; margin-left: auto; margin-right: auto; background: white; padding: 10px; border-radius: 50px; display: flex; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <span style="margin-left: 20px; color: #64748b;">üîç Search by county or city...</span>
        <a href="#directory" style="margin-left: auto; background: #1b4332; color: white; padding: 12px 30px; border-radius: 40px; text-decoration: none; font-weight: 800;">BROWSE MAP</a>
    </div>
  </header>

  <div class="container">
    <section id="directory" style="margin-top: 6rem; margin-bottom: 10rem;">
      <h2 style="text-align: center; color: #064e3b; font-size: 2.5rem; margin-bottom: 4rem; font-weight: 900;">Service Directory by County</h2>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 2.5rem;">
        {counties.map((county) => (
          <div style="background: white; padding: 2rem; border-radius: 24px; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px;">
                <span style="font-size: 1.5rem;">üìç</span>
                <h3 style="color: #064e3b; font-size: 1.4rem; margin: 0; font-weight: 800;">{county} County</h3>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              {groupedCities[county].map((city: any) => (
                <a 
                  href={`/tree-removal-${city.City.toLowerCase().replace(/\s+/g, '-')}`}
                  style="text-decoration: none; color: #4b5563; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; transition: 0.2s;"
                  class="city-link"
                >
                  <span style="color: #ea580c; font-size: 0.8rem;">‚ñ∂</span> {city.City}
                </a>
              ))}
            </div>
          </div>
        ))}
      </div>
    </section>
  </div>
</MainLayout>

<style>
  .city-link:hover { color: #ea580c !important; transform: translateX(3px); }
</style>