---
import fs from "node:fs";
import path from "node:path";
import { parse } from "csv-parse/sync";
import MainLayout from "../layouts/MainLayout.astro";
import { SITE_CONFIG } from "../config.js";

const filePath = path.resolve("./src/data/cities.csv");
const fileContent = fs.readFileSync(filePath, "utf-8");
const records = parse(fileContent, {
  columns: true,
  skip_empty_lines: true,
  bom: true,
});

// M√ºkerrerleri temizle ve ƒ∞l√ßelere (County) g√∂re grupla
const seenCities = new Set();
const groupedCities = records.reduce((acc: any, city: any) => {
  const cityName = city.City.trim();
  const lowerCity = cityName.toLowerCase();

  if (!seenCities.has(lowerCity)) {
    seenCities.add(lowerCity);
    const county = city.County || "Florida Areas";
    if (!acc[county]) acc[county] = [];
    acc[county].push(city);
  }
  return acc;
}, {});

const counties = Object.keys(groupedCities).sort();

const toTitleCase = (str) => {
  if (!str) return "";
  return str
    .toLowerCase()
    .split(" ")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
};

// POP√úLER ≈ûEHƒ∞RLER Lƒ∞STESƒ∞ (Senin verdiƒüin listeden en b√ºy√ºk 8 tanesi)
const featuredCities = [
  { name: "Miami", slug: "miami", icon: "üèôÔ∏è", desc: "Dade County" },
  { name: "Orlando", slug: "orlando", icon: "üé¢", desc: "Orange County" },
  { name: "Tampa", slug: "tampa", icon: "‚öì", desc: "Hillsborough" },
  {
    name: "Jacksonville",
    slug: "jacksonville",
    icon: "üåâ",
    desc: "Duval County",
  },
  {
    name: "Fort Lauderdale",
    slug: "fort-lauderdale",
    icon: "üõ•Ô∏è",
    desc: "Broward County",
  },
  { name: "Tallahassee", slug: "tallahassee", icon: "üèõÔ∏è", desc: "Leon County" },
  { name: "Cape Coral", slug: "cape-coral", icon: "üèñÔ∏è", desc: "Lee County" },
  {
    name: "St. Petersburg",
    slug: "st-petersburg",
    icon: "‚òÄÔ∏è",
    desc: "Pinellas County",
  },
];
---

<MainLayout
  title="Florida's #1 Certified Tree Service Directory | 2000+ Locations"
  description="The official 2026 directory for Florida tree care. Connecting homeowners with certified arborists in 67 counties."
>
  <!-- HERO SECTION -->
  <header
    style="background: linear-gradient(135deg, #1b4332 0%, #081c15 100%); color: white; padding: 6rem 1.5rem; text-align: center; border-bottom: 6px solid #ea580c;"
  >
    <div class="container">
      <h1
        style="font-size: clamp(2.5rem, 8vw, 4.5rem); margin: 0; letter-spacing: -2px; font-weight: 900; line-height: 0.95;"
      >
        FLORIDA TREE <br /><span style="color: #ffb703;">SERVICE NETWORK</span>
      </h1>
      <p
        style="font-size: 1.2rem; color: #95d5b2; margin-top: 2rem; max-width: 800px; margin-left: auto; margin-right: auto;"
      >
        Verified Experts & Emergency Removal Across 67 Counties.
      </p>

      <!-- LIVE SEARCH BOX -->
      <div
        style="margin-top: 3.5rem; max-width: 650px; margin-left: auto; margin-right: auto; background: white; padding: 6px; border-radius: 50px; display: flex; align-items: center; box-shadow: 0 15px 35px rgba(0,0,0,0.4); border: 2px solid #ea580c;"
      >
        <div style="padding-left: 20px; font-size: 1.4rem;">üîç</div>
        <input
          type="text"
          id="citySearch"
          placeholder="Type your city (e.g. Miami, Tampa...)"
          style="width: 100%; border: none; padding: 15px 12px; font-size: 1.15rem; border-radius: 50px; outline: none; color: #1b4332; font-weight: 600;"
        />
      </div>
      <p
        id="searchStatus"
        style="margin-top: 20px; font-size: 1rem; color: #ffb703; font-weight: 700; display: none;"
      >
        No areas found matching your search.
      </p>
    </div>
  </header>

  <div class="container">
    <!-- STATS / TRUST SECTION -->
    <section
      style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; margin-top: -3rem; position: relative; z-index: 20;"
    >
      <div class="stat-card">
        üå™Ô∏è <h3>Emergency</h3><p>Immediate storm response dispatch.</p>
      </div>
      <div class="stat-card">
        üõ°Ô∏è <h3>Vetted Pros</h3><p>Licensed & insured specialists.</p>
      </div>
      <div class="stat-card">
        üèóÔ∏è <h3>Full Service</h3><p>Removal, grinding & pruning.</p>
      </div>
    </section>

    <!-- NEW: MAJOR HUB CARDS (Senin ƒ∞stediƒüin Kƒ±sƒ±mlar) -->
    <section style="margin-top: 6rem;">
      <h2
        style="text-align: center; color: #064e3b; font-size: 2.2rem; margin-bottom: 0.5rem; font-weight: 900;"
      >
        Major Service Hubs
      </h2>
      <p style="text-align: center; color: #64748b; margin-bottom: 3rem;">
        Quick access to Florida's largest metropolitan areas.
      </p>

      <div class="hub-grid">
        {
          featuredCities.map((city) => (
            <a href={`/tree-removal-${city.slug}`} class="hub-card">
              <span class="hub-icon">{city.icon}</span>
              <div class="hub-info">
                <h4>{city.name}</h4>
                <span>{city.desc}</span>
              </div>
              <span class="hub-arrow">‚Üí</span>
            </a>
          ))
        }
      </div>
    </section>

    <!-- DIRECTORY SECTION (3 S√úTUNLU AKILLI YAPI) -->
    <section id="directory" style="margin-top: 8rem; margin-bottom: 12rem;">
      <div style="border-top: 2px solid #f1f5f9; padding-top: 4rem;">
        <h2
          style="text-align: center; color: #064e3b; font-size: 2rem; margin-bottom: 3rem; font-weight: 900;"
        >
          Browse All 67 Florida Counties
        </h2>

        <div id="countyGrid" class="directory-grid">
          {
            counties.map((county) => (
              <div class="county-card" data-county={county.toLowerCase()}>
                <button class="county-toggle" aria-expanded="false">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1rem;">üå¥</span>
                    <span class="county-name">{toTitleCase(county)}</span>
                  </div>
                  <span class="chevron">‚ñº</span>
                </button>

                <div class="city-list-content">
                  <div style="display: grid; grid-template-columns: 1fr; gap: 15px; padding: 1.5rem; border-top: 1px solid #f1f5f9;">
                    {groupedCities[county].map((city: any) => {
                      const citySlug = city.City.toLowerCase()
                        .trim()
                        .replace(/\s+/g, "-");
                      return (
                        <div
                          class="city-item"
                          data-city={city.City.toLowerCase()}
                        >
                          <a
                            href={`/tree-removal-${citySlug}`}
                            class="main-service-link"
                          >
                            {toTitleCase(city.City)} Tree Service
                          </a>
                          <div class="sub-services">
                            <a href={`/stump-grinding-${citySlug}`}>
                              üèóÔ∏è Stump Grinding
                            </a>
                            <a href={`/emergency-service-${citySlug}`}>
                              ‚ö° Emergency
                            </a>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            ))
          }
        </div>
      </div>
    </section>
  </div>
</MainLayout>

<style>
  /* STATS */
  .stat-card {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    text-align: center;
  }
  .stat-card h3 {
    color: #064e3b;
    margin: 10px 0 0;
    font-weight: 900;
  }
  .stat-card p {
    color: #64748b;
    font-size: 0.85rem;
    margin-top: 5px;
  }

  /* HUB CARDS (YENƒ∞) */
  .hub-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 1.5rem;
  }
  .hub-card {
    background: white;
    padding: 1.5rem;
    border-radius: 16px;
    border: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 15px;
    text-decoration: none;
    transition: all 0.3s ease;
  }
  .hub-card:hover {
    transform: translateY(-5px);
    border-color: #ea580c;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
  }
  .hub-icon {
    font-size: 2rem;
  }
  .hub-info h4 {
    margin: 0;
    color: #1b4332;
    font-weight: 800;
  }
  .hub-info span {
    font-size: 0.75rem;
    color: #64748b;
    font-weight: 600;
  }
  .hub-arrow {
    margin-left: auto;
    color: #cbd5e1;
    font-weight: 900;
  }
  .hub-card:hover .hub-arrow {
    color: #ea580c;
  }

  /* DIRECTORY GRID (SCROLL AZALTAN YAPI) */
  .directory-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* Masa√ºst√ºnde 3 s√ºtun! */
    gap: 1.5rem;
  }
  @media (max-width: 1024px) {
    .directory-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  @media (max-width: 768px) {
    .directory-grid {
      grid-template-columns: 1fr;
    }
  }

  .county-card {
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    overflow: hidden;
    height: fit-content;
  }
  .county-toggle {
    width: 100%;
    padding: 1rem;
    background: none;
    border: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }
  .county-name {
    color: #1b4332;
    font-weight: 800;
    font-size: 0.95rem;
  }
  .chevron {
    font-size: 0.7rem;
    color: #94a3b8;
    transition: transform 0.3s;
  }

  /* ACCORDION */
  .city-list-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0, 1, 0, 1);
    background: #fff;
  }
  .county-card.is-open .city-list-content {
    max-height: 5000px;
    transition: max-height 0.4s ease-in-out;
  }
  .county-card.is-open .chevron {
    transform: rotate(180deg);
    color: #ea580c;
  }
  .county-card.is-open {
    border-color: #ea580c;
  }

  /* CITY ITEMS */
  .city-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
    border-bottom: 1px solid #f8fafc;
    padding-bottom: 10px;
  }
  .main-service-link {
    text-decoration: none;
    color: #1b4332;
    font-weight: 800;
    font-size: 0.9rem;
  }
  .sub-services {
    display: flex;
    gap: 10px;
  }
  .sub-services a {
    text-decoration: none;
    color: #64748b;
    font-size: 0.65rem;
    font-weight: 700;
  }
  .sub-services a:hover {
    color: #ea580c;
  }
</style>

<script is:inline>
  const searchInput = document.getElementById("citySearch");
  const statusText = document.getElementById("searchStatus");
  const countyCards = document.querySelectorAll(".county-card");

  // Accordion Logic
  countyCards.forEach((card) => {
    const btn = card.querySelector(".county-toggle");
    btn.addEventListener("click", () => {
      const isOpen = card.classList.contains("is-open");
      card.classList.toggle("is-open", !isOpen);
    });
  });

  // Smart Search
  searchInput.addEventListener("input", (e) => {
    const term = e.target.value.toLowerCase().trim();
    let anyVisible = false;

    countyCards.forEach((card) => {
      const countyName = card.getAttribute("data-county");
      const cityItems = card.querySelectorAll(".city-item");
      let hasVisibleCity = false;

      if (term.length === 0) {
        card.style.display = "block";
        card.classList.remove("is-open");
        cityItems.forEach((i) => (i.style.display = "flex"));
        return;
      }

      cityItems.forEach((item) => {
        const cityName = item.getAttribute("data-city");
        if (cityName.includes(term) || countyName.includes(term)) {
          item.style.display = "flex";
          hasVisibleCity = true;
        } else {
          item.style.display = "none";
        }
      });

      if (hasVisibleCity || countyName.includes(term)) {
        card.style.display = "block";
        card.classList.add("is-open");
        anyVisible = true;
      } else {
        card.style.display = "none";
        card.classList.remove("is-open");
      }
    });

    statusText.style.display =
      term.length > 0 && !anyVisible ? "block" : "none";
  });
</script>
