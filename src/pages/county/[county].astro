---
import fs from "node:fs";
import path from "node:path";
import { parse } from "csv-parse/sync";
import MainLayout from "../../layouts/MainLayout.astro";
import { SITE_CONFIG } from "../../config.js";

export async function getStaticPaths() {
  const filePath = path.resolve("./src/data/cities.csv");
  const fileContent = fs.readFileSync(filePath, "utf-8");
  const records = parse(fileContent, {
    columns: true,
    skip_empty_lines: true,
    bom: true,
  });

  // Benzersiz ilÃ§eleri al
  const counties = [...new Set(records.map((r) => r.County))];

  return counties.map((county) => {
    const countySlug = county.toLowerCase().trim().replace(/\s+/g, "-");
    const citiesInCounty = records.filter((r) => r.County === county);

    return {
      params: { county: countySlug },
      props: {
        countyName: county,
        cities: citiesInCounty,
      },
    };
  });
}

const { countyName, cities } = Astro.props;
const displayCounty = countyName + " County";

const toTitleCase = (str) => {
  if (!str) return "";
  return str
    .toLowerCase()
    .split(" ")
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");
};
---

<MainLayout
  title={`Tree Services in ${displayCounty}, FL | Local Experts`}
  description={`Find licensed and insured tree removal, stump grinding, and emergency services in all cities across ${displayCounty}, Florida.`}
>
  <header
    style="background: linear-gradient(135deg, #1b4332 0%, #081c15 100%); color: white; padding: 5rem 1.5rem; text-align: center; border-bottom: 5px solid #ea580c;"
  >
    <div class="container">
      <div
        style="font-size: 0.85rem; margin-bottom: 1rem; color: #ffb703; font-weight: 800; text-transform: uppercase;"
      >
        Statewide Directory
      </div>
      <h1
        style="font-size: clamp(2.2rem, 7vw, 3.5rem); margin: 0; font-weight: 900;"
      >
        {displayCounty} Tree Experts
      </h1>
      <p style="font-size: 1.2rem; color: #95d5b2; margin-top: 1rem;">
        Complete service coverage for every city in {countyName}.
      </p>
    </div>
  </header>

  <main class="container" style="padding: 4rem 1.5rem 10rem;">
    <div
      style="background: white; padding: 2rem; border-radius: 24px; border: 1px solid #eee; margin-bottom: 4rem;"
    >
      <h2 style="color: #1b4332; font-weight: 800; margin-top: 0;">
        Service Hub for {displayCounty}
      </h2>
      <p style="color: #4b5563; line-height: 1.7;">
        ProTreeTrimâ„¢ maintains a prioritized dispatch network throughout <strong
          >{countyName}</strong
        >. Select your city below to get a local estimate for removal, trimming,
        or emergency cleanup.
      </p>
    </div>

    <div
      style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;"
    >
      {
        cities.map((city) => {
          const citySlug = city.City.toLowerCase()
            .trim()
            .replace(/\./g, "")
            .replace(/\s+/g, "-");
          return (
            <div
              style="background: white; padding: 1.5rem; border-radius: 16px; border: 1px solid #e5e7eb; transition: 0.3s;"
              class="city-hub-card"
            >
              <h3 style="margin: 0 0 10px; color: #1b4332; font-size: 1.1rem; font-weight: 800;">
                {toTitleCase(city.City)}
              </h3>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <a
                  href={`/tree-removal-${citySlug}`}
                  style="text-decoration: none; color: #4b5563; font-size: 0.85rem; font-weight: 700;"
                >
                  ğŸŒ³ Tree Removal â†’
                </a>
                <a
                  href={`/stump-grinding-${citySlug}`}
                  style="text-decoration: none; color: #4b5563; font-size: 0.85rem; font-weight: 700;"
                >
                  ğŸ—ï¸ Stump Grinding â†’
                </a>
                <a
                  href={`/emergency-service-${citySlug}`}
                  style="text-decoration: none; color: #ea580c; font-size: 0.85rem; font-weight: 900;"
                >
                  ğŸŒªï¸ Emergency Response â†’
                </a>
              </div>
            </div>
          );
        })
      }
    </div>
  </main>
</MainLayout>

<style>
  .city-hub-card:hover {
    border-color: #ea580c !important;
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
  }
</style>
